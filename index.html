<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        :root {
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --emerald-400: #34d399;
            --emerald-500: #10b981;
            --blue-500: #3b82f6;
            --yellow-500: #eab308;
            --red-500: #ef4444;
            --purple-500: #8b5cf6;
            --gray-500: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--slate-900);
            color: var(--slate-300);
        }

        /* --- SweetAlert2 Dark Theme --- */
        .swal2-popup {
            background-color: var(--slate-800) !important;
            color: var(--slate-300) !important;
        }
        .swal2-title {
            color: white !important;
        }
        .swal2-confirm {
            background-color: var(--emerald-500) !important;
        }
        .swal2-cancel {
            background-color: var(--slate-600) !important;
        }
        .swal2-input {
             background-color: var(--slate-700) !important;
             color: white !important;
             border-color: var(--slate-600) !important;
        }
        .swal2-toast .swal2-title {
            color: white !important;
            margin: 0.5em 1em;
            font-size: 1em;
        }
        .swal2-toast .swal2-html-container {
             margin-left: 1em;
             margin-right: 1em;
        }


        /* --- Login Page --- */
        #login-page {
            min-height: 100vh;
        }
        .login-btn {
            background-color: var(--slate-800);
            border: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .login-btn:hover {
            background-color: var(--emerald-500);
            color: var(--slate-900) !important;
        }
        
        /* --- Header --- */
        .main-header {
            background-color: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
        }
        .nav-btn {
            color: var(--slate-300);
            background-color: transparent;
            border: none;
        }
        .nav-btn.active {
            background-color: var(--emerald-500);
            color: var(--slate-900);
        }
        .nav-btn:hover:not(.active) {
            background-color: var(--slate-700);
            color: white;
        }
        .mobile-nav .nav-btn {
            background-color: var(--slate-700);
            color: var(--slate-300);
        }
        .mobile-nav .nav-btn.active {
             background-color: var(--emerald-500);
            color: var(--slate-900);
        }

        /* --- Table Layout --- */
        .table-card-wrapper {
            position: relative;
        }
        .table-card {
            aspect-ratio: 1 / 1;
            transition: transform 0.2s;
        }
        .table-card:hover {
            transform: scale(1.05);
        }
        .table-card-admin-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }
         .table-card-admin-controls .btn {
            background-color: rgba(0,0,0,0.4);
            border: none;
        }
        .table-card.available { background-color: var(--slate-700); }
        .table-card.available:hover { background-color: var(--slate-600); }
        .table-card.occupied { background-color: var(--blue-500); }
        .table-card.occupied:hover { background-color: #2563eb; }
        .table-card.billing { background-color: var(--yellow-500); }
        .table-card.billing:hover { background-color: #ca8a04; }
        .table-card.reserved { background-color: var(--purple-500); }
        .table-card.reserved:hover { background-color: #7c3aed; }
        .table-card.unavailable { background-color: var(--gray-500); }
        .table-card.unavailable:hover { background-color: #4b5563; }

        /* --- Dashboard --- */
        .stat-card, .data-card {
            background-color: var(--slate-800);
        }
        .stat-card i { font-size: 2.5rem; }
        .list-group-item-dark {
            background-color: rgba(51, 65, 85, 0.5);
            border-color: var(--slate-700);
        }

        /* --- Kitchen Display --- */
        .kot-column {
            background-color: var(--slate-800);
        }
        .kot-card {
            background-color: var(--slate-700);
        }
        
        /* --- User/Reports/Menu Page --- */
        .user-card, .menu-category-card {
            background-color: var(--slate-800);
            border: 1px solid var(--slate-700);
        }
        .menu-item-row {
            border-bottom: 1px solid var(--slate-700);
        }
        .menu-item-row:last-child {
            border-bottom: none;
        }
        .nav-tabs .nav-link {
            background-color: transparent;
            border-color: transparent;
            color: var(--slate-400);
        }
        .nav-tabs .nav-link.active {
            background-color: var(--slate-800);
            color: white;
            border-color: var(--slate-700) var(--slate-700) var(--slate-800);
        }
        .tab-content {
            background-color: var(--slate-800);
        }

        /* --- Inventory --- */
        .table-dark {
            --bs-table-bg: var(--slate-800);
            --bs-table-border-color: var(--slate-700);
            --bs-table-header-bg: var(--slate-700);
        }
        .table-hover > tbody > tr:hover > * {
            --bs-table-hover-bg: rgba(51, 65, 85, 0.5);
        }
        .nav-pills .nav-link {
             color: var(--slate-300);
        }
        .nav-pills .nav-link.active {
            background-color: var(--emerald-500);
            color: var(--slate-900);
        }


        /* --- Modals --- */
        .modal-content {
            background-color: var(--slate-800);
            color: var(--slate-300);
            border: 1px solid var(--slate-700);
        }
        .modal-header, .modal-footer {
            border-bottom-color: var(--slate-700);
            border-top-color: var(--slate-700);
        }
        .form-control-dark, .form-select-dark {
            background-color: var(--slate-700);
            color: white;
            border-color: var(--slate-600);
        }
        .form-control-dark:focus, .form-select-dark:focus {
            background-color: var(--slate-700);
            color: white;
            border-color: var(--emerald-500);
            box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.25);
        }
        .menu-item-btn {
            background-color: var(--slate-700);
            border: none;
            color: white;
        }
        .menu-item-btn:hover {
            background-color: var(--emerald-500);
            color: var(--slate-900);
        }
        .order-summary, .bill-summary {
             background-color: rgba(15, 23, 42, 0.5);
        }
        .order-item {
            background-color: var(--slate-700);
        }
        .quantity-btn {
            background-color: var(--slate-600);
            color: white;
            width: 28px;
            height: 28px;
            border: none;
        }
        .quantity-btn:disabled {
            background-color: var(--slate-700);
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modifier-item {
            font-size: 0.85rem;
            color: var(--slate-400);
            padding-left: 1rem;
        }
        #modifiers-list .input-group {
            margin-bottom: 0.5rem;
        }
        
        /* --- Toast Notifications --- */
        .toast-container {
            z-index: 1100; /* Higher than modals */
        }

        /* --- Utility & Animations --- */
        .icon-lg { font-size: 4rem; }
        .text-emerald { color: var(--emerald-400); }
        .text-slate-400 { color: var(--slate-400); }
        .text-info { color: #0ea5e9 !important; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="login-page" class="d-flex flex-column justify-content-center align-items-center p-4">
        <div class="text-center mb-5">
            <i class="bi bi-egg-fried icon-lg text-emerald mb-4"></i>
            <h1 class="display-5 fw-bold text-white">Restaurant POS</h1>
            <p class="text-slate-400 mt-2">Select a user role to start the demo.</p>
        </div>
        <div id="login-form" class="w-100" style="max-width: 380px;">
            <!-- Login buttons will be injected here by JS -->
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="d-none">
        <!-- Header -->
        <header id="main-header" class="main-header shadow-lg sticky-top"></header>
        
        <!-- Main Content -->
        <main id="main-content" class="container-fluid p-3 p-sm-4 p-lg-5 fade-in"></main>
    </div>

    <!-- Modals -->
    <!-- Order Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title fs-4 fw-bold text-white" id="orderModalLabel"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 75vh;">
                    <div class="row g-4">
                        <div class="col-lg-7">
                            <div id="menu-container" class="overflow-auto pe-2" style="max-height: 65vh;"></div>
                        </div>
                        <div class="col-lg-5">
                            <div class="order-summary p-3 rounded-3 d-flex flex-column h-100">
                                <div id="customer-details-section" class="mb-3"></div>
                                <h3 class="fs-5 fw-bold text-white mb-3">Current Order</h3>
                                <div id="current-order-items" class="flex-grow-1 overflow-auto pe-2" style="min-height: 200px;">
                                    <p class="text-slate-400 text-center pt-5">No items added yet.</p>
                                </div>
                                <div id="order-modal-footer" class="mt-auto border-top border-secondary pt-3">
                                    <div class="d-flex justify-content-between align-items-center fs-3 fw-bold text-white mb-3">
                                        <span>Total:</span>
                                        <span id="order-total">$0.00</span>
                                    </div>
                                    <button id="place-order-btn" class="btn btn-lg w-100 fw-bold" style="background-color: var(--emerald-500); color: var(--slate-900);" disabled>Place Order</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Item Customization Modal -->
    <div class="modal fade" id="itemCustomizationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fs-5 fw-bold text-white" id="customizationModalLabel"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customization-form">
                        <p>Select your add-ons:</p>
                        <div id="modifiers-container" class="d-grid gap-2">
                           <!-- Modifiers will be injected here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="add-customized-item-btn" class="btn btn-primary">Add to Order</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Billing Modal -->
    <div class="modal fade" id="billingModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content rounded-4">
            <div class="modal-header">
                <h5 class="modal-title fs-4 fw-bold text-white" id="billingModalLabel"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="bill-summary p-3 rounded-3 mb-3">
                    <h3 class="fs-6 fw-bold text-white mb-2">Order Summary</h3>
                    <div id="billing-items-summary"></div>
                </div>
                <div class="bill-summary p-3 rounded-3">
                    <div id="billing-totals-summary"></div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                 <div id="payment-buttons" class="d-grid gap-3 w-100"></div>
            </div>
        </div>
      </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="user-form">
                    <div class="modal-header">
                        <h5 class="modal-title fs-4 fw-bold text-white" id="userModalLabel">Add New User</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="user-id">
                        <div class="mb-3">
                            <label for="user-name" class="form-label">Full Name</label>
                            <input type="text" class="form-control form-control-dark" id="user-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="user-role" class="form-label">Role</label>
                            <select class="form-select form-control-dark" id="user-role" required>
                                <option value="Waiter">Waiter</option>
                                <option value="Kitchen">Kitchen</option>
                                <option value="Cashier">Cashier</option>
                                <option value="Bartender">Bartender</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Inventory Management Modal -->
    <div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="inventory-form">
                    <div class="modal-header">
                        <h5 class="modal-title fs-4 fw-bold text-white" id="inventoryModalLabel">Add Ingredient</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="inventory-item-id">
                        <input type="hidden" id="inventory-item-original-category">
                        <div class="mb-3">
                            <label for="inventory-item-name" class="form-label">Ingredient Name</label>
                            <input type="text" class="form-control form-control-dark" id="inventory-item-name" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="inventory-item-category" class="form-label">Category</label>
                                <select class="form-select form-control-dark" id="inventory-item-category" required>
                                    <option value="kitchen">Kitchen</option>
                                    <option value="bar">Bar</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="inventory-item-unit" class="form-label">Unit</label>
                                <input type="text" class="form-control form-control-dark" id="inventory-item-unit" placeholder="e.g., kg, liters, units" required>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-6 mb-3">
                                <label for="inventory-item-stock" class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control form-control-dark" id="inventory-item-stock" step="any" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="inventory-item-low-stock" class="form-label">Low Stock Threshold</label>
                                <input type="number" class="form-control form-control-dark" id="inventory-item-low-stock" step="any" min="0" required>
                            </div>
                        </div>
                         <div class="mb-3">
                            <label for="inventory-item-supplier" class="form-label">Supplier</label>
                            <input type="text" class="form-control form-control-dark" id="inventory-item-supplier">
                        </div>
                         <div class="mb-3">
                            <label for="inventory-item-cost" class="form-label">Unit Cost</label>
                            <input type="number" class="form-control form-control-dark" id="inventory-item-cost" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Table Management Modal -->
    <div class="modal fade" id="tableModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="table-form">
                    <div class="modal-header">
                        <h5 class="modal-title fs-4 fw-bold text-white" id="tableModalLabel">Add New Table</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="table-id">
                        <div class="mb-3">
                            <label for="table-name" class="form-label">Table Name</label>
                            <input type="text" class="form-control form-control-dark" id="table-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="table-status" class="form-label">Status</label>
                            <select class="form-select form-control-dark" id="table-status" required>
                                <option value="available">Available</option>
                                <option value="reserved">Reserved</option>
                                <option value="unavailable">Unavailable</option>
                                <!-- Occupied and Billing are set via orders, not manually -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Table</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Menu Item Management Modal -->
    <div class="modal fade" id="menuItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="menu-item-form">
                    <div class="modal-header">
                        <h5 class="modal-title fs-4 fw-bold text-white" id="menuItemModalLabel">Add New Menu Item</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="menu-item-id">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="menu-item-name" class="form-label">Item Name</label>
                                <input type="text" class="form-control form-control-dark" id="menu-item-name" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="menu-item-price" class="form-label">Price</label>
                                <input type="number" class="form-control form-control-dark" id="menu-item-price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="menu-item-category" class="form-label">Category</label>
                                <select class="form-select form-select-dark" id="menu-item-category" required></select>
                            </div>
                             <div class="col-md-6 mb-3">
                                <label for="menu-item-stock" class="form-label">Initial Stock</label>
                                <input type="number" class="form-control form-control-dark" id="menu-item-stock" min="0" required>
                            </div>
                        </div>
                        <hr class="border-secondary">
                        <div class="form-check form-switch mb-3">
                           <input class="form-check-input" type="checkbox" role="switch" id="menu-item-customizable">
                           <label class="form-check-label" for="menu-item-customizable">Item is Customizable (has add-ons)</label>
                        </div>
                        <div id="modifiers-management-section" style="display: none;">
                            <label class="form-label">Modifiers (Add-ons)</label>
                            <div id="modifiers-list">
                                <!-- Dynamic modifier inputs go here -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-info" id="add-modifier-btn"><i class="bi bi-plus"></i> Add Modifier</button>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>


    <!-- JQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <script>
        $(document).ready(function() {
            // --- AUDIO CONTEXT for Web Audio API ---
            let audioCtx;
            // A gesture from the user is required to start the audio context.
            // We'll initialize it on the first login click.
            function initAudio() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
            }
            
            // --- CHART.JS DEFAULTS FOR DARK THEME ---
            Chart.defaults.color = 'rgba(148, 163, 184, 0.7)'; // slate-400
            Chart.defaults.borderColor = 'rgba(51, 65, 85, 0.5)'; // slate-700 with opacity

            // --- STATE MANAGEMENT (Global Variables) ---
            let state = {
                currentUser: null,
                currentPage: 'Tables',
                tables: [],
                orders: [], // Completed orders for reporting
                kitchenOrders: [], // Live kitchen orders
                barOrders: [], // Live bar orders
                inventory: {}, // Changed to an object
                menu: {},
                users: {},
                activeModalTableId: null,
                activeOrder: { // Now an object to hold more details
                    orderType: 'Dining', // Dining, Take Away, Delivery
                    deliveryMethod: null, // uber, pickme, self
                    customerName: '',
                    customerContact: '',
                    customerAddress: '',
                    referenceNumber: '',
                    items: []
                },
                itemToCustomize: null,
                salesChart: null,
                report: {
                    activeReport: 'sales', // 'sales', 'inventory'
                    range: '7days', // '7days', 'custom'
                    year: new Date('2025-10-08T10:53:00').getFullYear(),
                    month: 'all', // 'all' or 0-11
                }
            };

            // --- MOCK DATA INITIALIZATION ---
            function initializeData() {
                state.menu = {
                  Appetizers: [
                    { id: 1, name: "Spring Rolls", price: 8.50 },
                    { id: 2, name: "Garlic Bread", price: 6.00 },
                    { id: 3, name: "Bruschetta", price: 9.00 },
                  ],
                  'Main Course': [
                    { id: 4, name: "Spaghetti Carbonara", price: 18.00 },
                    { id: 5, name: "Grilled Salmon", price: 24.50 },
                    { id: 6, name: "Margherita Pizza", price: 15.00, customizable: true, modifiers: [
                        { name: 'Extra Cheese', price: 1.50 }, { name: 'Olives', price: 1.00 }, { name: 'Mushrooms', price: 1.25 }
                    ]},
                    { id: 7, name: "Chicken Alfredo", price: 19.50 },
                  ],
                  Desserts: [
                    { id: 8, name: "Tiramisu", price: 9.50 },
                    { id: 9, name: "Cheesecake", price: 8.00 },
                    { id: 10, name: "Chocolate Lava Cake", price: 10.00 },
                  ],
                  Beverages: [
                    { id: 11, name: "Cola", price: 3.50 },
                    { id: 12, name: "Orange Juice", price: 4.00 },
                    { id: 13, name: "Espresso", price: 3.00 },
                  ],
                   Liqueur: [
                    { id: 14, name: "Red Wine (Glass)", price: 8.00 },
                    { id: 15, name: "Local Beer", price: 6.50 },
                    { id: 16, name: "Whiskey (Single)", price: 9.00 },
                  ]
                };

                state.tables = Array.from({ length: 12 }, (_, i) => ({
                    id: i + 1,
                    name: `Table ${i + 1}`,
                    status: 'available',
                    order: [],
                }));

                state.inventory = {
                    kitchen: [
                        { id: 'k1', name: 'Pizza Dough', unit: 'units', stock: 40, lowStockThreshold: 10, supplier: 'Dough Masters', cost: 1.50 },
                        { id: 'k2', name: 'Tomato Sauce', unit: 'liters', stock: 20, lowStockThreshold: 5, supplier: 'Italian Imports', cost: 2.00 },
                        { id: 'k3', name: 'Mozzarella Cheese', unit: 'kg', stock: 15, lowStockThreshold: 4, supplier: 'Dairy Farms', cost: 8.50 },
                        { id: 'k4', name: 'Salmon Fillet', unit: 'kg', stock: 10, lowStockThreshold: 2, supplier: 'Ocean Fresh', cost: 22.00 },
                        { id: 'k5', name: 'Pasta', unit: 'kg', stock: 30, lowStockThreshold: 5, supplier: 'Italian Imports', cost: 3.00 },
                    ],
                    bar: [
                        { id: 'b1', name: 'Whiskey', unit: 'bottles', stock: 12, lowStockThreshold: 2, supplier: 'Fine Spirits', cost: 35.00 },
                        { id: 'b2', name: 'Cola', unit: 'cans', stock: 150, lowStockThreshold: 24, supplier: 'Soda Co.', cost: 0.50 },
                        { id: 'b3', name: 'Espresso Beans', unit: 'kg', stock: 10, lowStockThreshold: 1, supplier: 'Coffee World', cost: 15.00 },
                    ],
                    general: [
                        { id: 'g1', name: 'Napkins', unit: 'packs', stock: 50, lowStockThreshold: 10, supplier: 'Gen Supplies', cost: 2.50 },
                        { id: 'g2', name: 'Takeaway Boxes', unit: 'units', stock: 200, lowStockThreshold: 50, supplier: 'Packaging Inc.', cost: 0.20 },
                    ]
                };
                
                state.users = {
                    'admin': { id: 'admin', name: 'Alex Green', role: 'Admin' },
                    'manager': { id: 'manager', name: 'Brenda Smith', role: 'Manager' },
                    'waiter': { id: 'waiter', name: 'Charles Davis', role: 'Waiter' },
                    'kitchen': { id: 'kitchen', name: 'Diana Prince', role: 'Kitchen' },
                    'cashier': { id: 'cashier', name: 'Edward Frank', role: 'Cashier' },
                    'bartender': {id: 'bartender', name: 'Fiona Gable', role: 'Bartender'}
                };

                const generateMockOrders = () => {
                    const orders = [];
                    const today = new Date('2025-10-08T10:53:00');

                    const createOrder = (date, total) => ({
                        id: date.getTime() + Math.random(),
                        tableId: Math.ceil(Math.random() * 12),
                        tableName: `Table ${Math.ceil(Math.random() * 12)}`,
                        items: [{ id: 1, name: "Sample Item", price: total, quantity: 1 }],
                        total: total,
                        status: 'completed',
                        timestamp: date.toISOString(),
                    });

                    // Current year data
                    for (let m = 0; m <= today.getMonth(); m++) {
                         for (let d = 0; d < 15; d++) {
                             const date = new Date(today.getFullYear(), m, (d * 2) + 1);
                             if (date <= today) {
                                orders.push(createOrder(date, Math.random() * 200 + 50));
                             }
                         }
                    }

                    // Previous year data
                    for (let m = 0; m < 12; m++) {
                         for (let d = 0; d < 8; d++) {
                             const date = new Date(today.getFullYear() - 1, m, (d * 3) + 1);
                             orders.push(createOrder(date, Math.random() * 180 + 40));
                         }
                    }
                    
                    state.orders = orders;
                };

                generateMockOrders();
            }

            // --- HELPER FUNCTIONS ---
            function playSound(type) {
                if (!audioCtx) {
                    console.warn("AudioContext not initialized. User interaction needed.");
                    return;
                }

                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.01); // Increased volume
                
                oscillator.type = 'sine';

                switch (type) {
                    case 'new-order':
                        oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
                        break;
                    case 'order-ready':
                        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                        setTimeout(() => { oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.15); }, 150);
                        break;
                    case 'billing-ready':
                         oscillator.frequency.setValueAtTime(698.46, audioCtx.currentTime); // F5
                        break;
                }
                
                oscillator.start(audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1.0); // Increased duration
                oscillator.stop(audioCtx.currentTime + 1.0); // Increased duration
            }
            
            function showToast(message, type = 'success') {
                const toastId = `toast-${Date.now()}`;
                const toastBg = type === 'success' ? 'bg-success' : (type === 'danger' ? 'bg-danger' : 'bg-info');
                const toastHtml = `
                    <div id="${toastId}" class="toast align-items-center text-white ${toastBg} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                $('.toast-container').append(toastHtml);
                const toastElement = new bootstrap.Toast($(`#${toastId}`));
                toastElement.show();
                $(`#${toastId}`).on('hidden.bs.toast', function () {
                    $(this).remove();
                });
            }
            
             function getCategoryByItemId(itemId) {
                 for (const category in state.menu) {
                     if (state.menu[category].some(item => item.id === itemId)) {
                         return category;
                     }
                 }
                 return null;
             }

             function calculateOrderDifference(oldOrder, newOrder) {
                 const diff = [];
                 const oldOrderMap = new Map((oldOrder || []).map(item => [item.customId || item.id, item.quantity]));

                 for (const newItem of newOrder) {
                     const key = newItem.customId || newItem.id;
                     const oldQuantity = oldOrderMap.get(key) || 0;
                     const quantityDiff = newItem.quantity - oldQuantity;

                     if (quantityDiff > 0) {
                         diff.push({ ...newItem, quantity: quantityDiff });
                     }
                 }
                 return diff;
             }



            // --- RENDER FUNCTIONS ---
            
            // Main render function
            function render() {
                if (state.currentUser) {
                    $('#login-page').addClass('d-none');
                    $('#app').removeClass('d-none');
                    renderHeader();
                    renderPage();
                } else {
                    $('#login-page').removeClass('d-none');
                    $('#app').addClass('d-none');
                    renderLoginPage();
                }
            }

            function renderLoginPage() {
                const loginForm = $('#login-form');
                loginForm.empty();
                $.each(state.users, (key, user) => {
                    loginForm.append(`
                        <button class="btn btn-lg login-btn text-white w-100 p-3 mb-3 d-flex justify-content-between align-items-center" data-role-id="${user.id}">
                            <span class="fw-semibold">Login as <span class="fw-bold">${user.role}</span></span>
                            <i class="bi bi-box-arrow-in-right fs-5"></i>
                        </button>
                    `);
                });
            }

            function renderHeader() {
                const navLinks = {
                    Admin: ['Dashboard', 'Tables', 'Menu', 'Kitchen', 'Bar', 'Inventory', 'Reports', 'Users'],
                    Manager: ['Dashboard', 'Tables', 'Menu', 'Kitchen', 'Bar', 'Inventory', 'Reports'],
                    Waiter: ['Tables'],
                    Kitchen: ['Kitchen'],
                    Cashier: ['Dashboard', 'Tables'],
                    Bartender: ['Bar'],
                };
                const icons = {
                    Dashboard: 'bi-bar-chart-line-fill',
                    Tables: 'bi-grid-1x2-fill',
                    Menu: 'bi-journal-text',
                    Kitchen: 'bi-egg-fried',
                    Bar: 'bi-cup-straw',
                    Inventory: 'bi-cart-fill',
                    Reports: 'bi-file-earmark-bar-graph-fill',
                    Users: 'bi-people-fill',
                };
                
                const links = navLinks[state.currentUser.role];
                const desktopNavHtml = links.map(page => `
                    <button class="btn nav-btn rounded-pill px-3 py-2 me-2 nav-link ${state.currentPage === page ? 'active' : ''}" data-page="${page}">
                        <i class="bi ${icons[page]} me-2"></i>${page}
                    </button>
                `).join('');
                
                 let newOrderButtons = '';
                 if(['Admin', 'Manager', 'Waiter', 'Cashier'].includes(state.currentUser.role)) {
                     newOrderButtons = `
                         <button class="btn btn-outline-success ms-2 new-order-btn" data-order-type="Take Away"><i class="bi bi-bag me-2"></i>Take Away</button>
                         <button class="btn btn-outline-primary ms-2 new-order-btn" data-order-type="Delivery"><i class="bi bi-truck me-2"></i>Delivery</button>
                     `;
                 }


                const mobileNavHtml = links.map(page => `
                    <button class="btn nav-btn rounded-pill px-3 py-2 flex-shrink-0 nav-link ${state.currentPage === page ? 'active' : ''}" data-page="${page}">
                        <i class="bi ${icons[page]} me-2"></i>${page}
                    </button>
                `).join('');

                $('#main-header').html(`
                    <nav class="navbar navbar-expand-md">
                        <div class="container-fluid">
                            <a class="navbar-brand text-white fw-bold fs-4 d-flex align-items-center" href="#">
                                <i class="bi bi-egg-fried text-emerald me-2 fs-3"></i>
                                <span class="d-none d-sm-inline">POS System</span>
                            </a>
                            <div class="d-none d-md-flex align-items-center">
                                ${desktopNavHtml}
                                <div class="vr mx-2"></div>
                                ${newOrderButtons}
                            </div>
                            <div class="d-flex align-items-center ms-auto">
                                <div class="text-end me-3">
                                    <div class="text-white fw-medium">${state.currentUser.name}</div>
                                    <small class="text-slate-400">${state.currentUser.role}</small>
                                </div>
                                <button id="logout-btn" class="btn btn-danger">Logout</button>
                            </div>
                        </div>
                    </nav>
                    <div class="d-md-none mobile-nav d-flex overflow-auto p-2 gap-2">
                        ${mobileNavHtml}
                    </div>
                `);
            }
            
            function renderPage() {
                $('#main-content').html(''); // Clear previous content
                if (state.salesChart) {
                    state.salesChart.destroy();
                    state.salesChart = null;
                }

                switch (state.currentPage) {
                    case 'Dashboard': renderDashboardPage(); break;
                    case 'Tables': renderTableLayoutPage(); break;
                    case 'Menu': renderMenuManagementPage(); break;
                    case 'Kitchen': renderKitchenPage(); break;
                    case 'Bar': renderBarPage(); break;
                    case 'Inventory': renderInventoryPage(); break;
                    case 'Reports': renderReportsPage(); break;
                    case 'Users': renderUserManagementPage(); break;
                    default: renderTableLayoutPage(); break;
                }
            }

            function renderTableLayoutPage() {
                const isAdmin = state.currentUser.role === 'Admin';
                
                let adminHeader = '';
                if(isAdmin) {
                    adminHeader = `
                        <div class="d-flex justify-content-between align-items-center mb-4">
                             <h1 class="text-3xl fw-bold text-white mb-0">Table Layout</h1>
                             <button class="btn btn-success d-flex align-items-center" id="add-table-btn">
                                 <i class="bi bi-plus-circle me-2"></i> Add Table
                             </button>
                        </div>
                    `;
                } else {
                     adminHeader = `<h1 class="text-3xl fw-bold text-white mb-4">Table Layout</h1>`;
                }

                const tableCards = state.tables.map(table => {
                    let adminControls = '';
                    if(isAdmin) {
                        adminControls = `
                            <div class="table-card-admin-controls">
                                <button class="btn btn-sm text-white edit-table-btn" data-table-id="${table.id}"><i class="bi bi-pencil-fill"></i></button>
                                <button class="btn btn-sm text-white remove-table-btn" data-table-id="${table.id}"><i class="bi bi-trash-fill"></i></button>
                            </div>
                        `;
                    }
                    return `
                        <div class="col">
                            <div class="table-card-wrapper">
                                ${adminControls}
                                <button class="btn table-card w-100 rounded-4 shadow d-flex flex-column justify-content-center align-items-center fw-bold fs-4 text-white ${table.status}" data-table-id="${table.id}" ${table.status === 'unavailable' ? 'disabled' : ''}>
                                    <span>${table.name}</span>
                                    <span class="fs-6 fw-normal text-capitalize">${table.status}</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                const content = `
                    ${adminHeader}
                    <div id="table-grid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-4">
                       ${tableCards}
                    </div>
                `;
                $('#main-content').html(content);
            }
            
            function renderDashboardPage() {
                const completedOrders = state.orders.filter(o => o.status === 'completed');
                const totalSales = completedOrders.reduce((sum, order) => sum + order.total, 0);
                const activeOrders = state.kitchenOrders.length + state.barOrders.length;
                const lowStockItems = [...state.inventory.kitchen, ...state.inventory.bar, ...state.inventory.general]
                    .filter(i => i.stock <= i.lowStockThreshold).length;


                // Top Selling Items
                const itemCounts = completedOrders
                    .flatMap(o => o.items)
                    .reduce((acc, item) => {
                        acc[item.name] = (acc[item.name] || 0) + item.quantity;
                        return acc;
                    }, {});

                const topSellingItems = Object.entries(itemCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5)
                    .map(([name, quantity]) => `
                        <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                            ${name} <span class="badge bg-success rounded-pill">${quantity} sold</span>
                        </li>
                    `).join('');
                
                // Recent Orders
                const recentOrders = state.orders.slice(-5).reverse().map(order => `
                    <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${order.tableName}</div>
                            <small class="text-slate-400">${order.items.length} items</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold fs-5">$${order.total.toFixed(2)}</div>
                            <span class="badge bg-success-subtle text-success-emphasis rounded-pill">${order.status}</span>
                        </div>
                    </li>
                `).join('');

                const content = `
                    <h1 class="text-3xl fw-bold text-white mb-4">Dashboard</h1>
                    <div class="row g-4 mb-4">
                        <!-- Stat Cards -->
                        <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Total Sales</p>
                                    <p class="fs-2 fw-bold text-white mb-0">$${totalSales.toFixed(2)}</p>
                                </div>
                                <i class="bi bi-cash-coin text-emerald"></i>
                            </div>
                        </div>
                         <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Active Orders</p>
                                    <p class="fs-2 fw-bold text-white mb-0">${activeOrders}</p>
                                </div>
                                <i class="bi bi-clock-history" style="color: var(--blue-500);"></i>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Completed Orders</p>
                                    <p class="fs-2 fw-bold text-white mb-0">${completedOrders.length}</p>
                                </div>
                                <i class="bi bi-check-circle-fill" style="color: #16a34a;"></i>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Low Stock Items</p>
                                    <p class="fs-2 fw-bold text-white mb-0">${lowStockItems}</p>
                                </div>
                                <i class="bi bi-exclamation-triangle-fill" style="color: var(--red-500);"></i>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <!-- Data Sections -->
                        <div class="col-lg-6">
                            <div class="data-card p-4 rounded-4 shadow">
                                <h2 class="fs-5 fw-bold text-white mb-3">Top Selling Items</h2>
                                <ul class="list-group">${topSellingItems || '<li class="list-group-item list-group-item-dark">No sales data yet.</li>'}</ul>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="data-card p-4 rounded-4 shadow">
                                <h2 class="fs-5 fw-bold text-white mb-3">Recent Orders</h2>
                                <ul class="list-group">${recentOrders || '<li class="list-group-item list-group-item-dark">No completed orders yet.</li>'}</ul>
                            </div>
                        </div>
                    </div>
                `;
                $('#main-content').html(content);
            }

            function renderKitchenPage() {
                const columns = {
                    New: state.kitchenOrders.filter(o => o.status === 'new'),
                    Preparing: state.kitchenOrders.filter(o => o.status === 'preparing'),
                    Ready: state.kitchenOrders.filter(o => o.status === 'ready'),
                };

                let columnsHtml = '';
                for (const [status, orders] of Object.entries(columns)) {
                    columnsHtml += `
                        <div class="col-md-4">
                            <div class="kot-column rounded-4 d-flex flex-column h-100">
                                <h2 class="fs-5 fw-bold text-white p-3 border-bottom border-secondary">${status} (${orders.length})</h2>
                                <div class="p-3 space-y-4 overflow-auto">
                                    ${orders.map(order => {
                                        let actionButton = '';
                                        if (status === 'New') actionButton = `<button class="btn btn-sm btn-primary kot-action-btn" data-order-id="${order.id}" data-action="preparing">Start</button>`;
                                        if (status === 'Preparing') actionButton = `<button class="btn btn-sm btn-success kot-action-btn" data-order-id="${order.id}" data-action="ready">Ready</button>`;
                                        if (status === 'Ready') actionButton = `<button class="btn btn-sm btn-secondary kot-action-btn" data-order-id="${order.id}" data-action="served">Serve</button>`;
                                        
                                        const itemsHtml = order.items.map(item => `
                                            <li>
                                                <span class="fw-semibold text-emerald">${item.quantity}x</span> ${item.name}
                                                ${item.modifiers && item.modifiers.length > 0 ? `
                                                    <ul class="list-unstyled ps-3">
                                                        ${item.modifiers.map(mod => `<li class="modifier-item">+ ${mod.name}</li>`).join('')}
                                                    </ul>
                                                ` : ''}
                                            </li>
                                        `).join('');
                                        
                                        let orderDetailsHtml = '';
                                        if (order.orderType === 'Take Away' || order.orderType === 'Delivery') {
                                            orderDetailsHtml += `<div class="small text-light mb-1"><i class="bi bi-person-fill"></i> ${order.customerName || 'N/A'}`;
                                            if(order.customerContact) {
                                                 orderDetailsHtml += ` | <i class="bi bi-telephone-fill"></i> ${order.customerContact}`;
                                            }
                                            orderDetailsHtml += `</div>`;
                                        }

                                        if (order.orderType === 'Delivery' && order.referenceNumber) {
                                            orderDetailsHtml += `<div class="small text-info mb-2"><i class="bi bi-hash"></i> ${order.referenceNumber}</div>`;
                                        }

                                        return `
                                            <div class="kot-card p-3 rounded-3 shadow-sm mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h3 class="fw-bold text-white fs-6 mb-0">${order.tableName}</h3>
                                                    <small class="text-slate-400">${new Date(order.timestamp).toLocaleTimeString()}</small>
                                                </div>
                                                ${orderDetailsHtml}
                                                <ul class="list-unstyled mb-3">${itemsHtml}</ul>
                                                <div class="d-flex justify-content-end gap-2">
                                                    ${status === 'Preparing' ? `<button class="btn btn-sm btn-outline-warning kot-action-btn" data-order-id="${order.id}" data-action="move-to-new">Back</button>` : ''}
                                                    ${status === 'Ready' ? `<button class="btn btn-sm btn-outline-warning kot-action-btn" data-order-id="${order.id}" data-action="move-to-preparing">Back</button>` : ''}
                                                    ${actionButton}
                                                </div>
                                            </div>
                                        `
                                    }).join('') || `<p class="text-slate-400 text-center p-5">No orders</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                }

                const content = `
                    <h1 class="text-3xl fw-bold text-white mb-4">Kitchen Orders (KOT)</h1>
                    <div class="row" style="min-height: 75vh;">${columnsHtml}</div>
                `;
                 $('#main-content').html(content);
            }

            function renderBarPage() {
                const columns = {
                    New: state.barOrders.filter(o => o.status === 'new'),
                    Preparing: state.barOrders.filter(o => o.status === 'preparing'),
                    Ready: state.barOrders.filter(o => o.status === 'ready'),
                };

                let columnsHtml = '';
                for (const [status, orders] of Object.entries(columns)) {
                    columnsHtml += `
                        <div class="col-md-4">
                            <div class="kot-column rounded-4 d-flex flex-column h-100">
                                <h2 class="fs-5 fw-bold text-white p-3 border-bottom border-secondary">${status} (${orders.length})</h2>
                                <div class="p-3 space-y-4 overflow-auto">
                                    ${orders.map(order => {
                                        let actionButton = '';
                                        if (status === 'New') actionButton = `<button class="btn btn-sm btn-primary bot-action-btn" data-order-id="${order.id}" data-action="preparing">Start</button>`;
                                        if (status === 'Preparing') actionButton = `<button class="btn btn-sm btn-success bot-action-btn" data-order-id="${order.id}" data-action="ready">Ready</button>`;
                                        if (status === 'Ready') actionButton = `<button class="btn btn-sm btn-secondary bot-action-btn" data-order-id="${order.id}" data-action="served">Serve</button>`;
                                        
                                        const itemsHtml = order.items.map(item => `
                                            <li>
                                                <span class="fw-semibold text-emerald">${item.quantity}x</span> ${item.name}
                                            </li>
                                        `).join('');

                                        return `
                                            <div class="kot-card p-3 rounded-3 shadow-sm mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h3 class="fw-bold text-white fs-6 mb-0">${order.tableName}</h3>
                                                    <small class="text-slate-400">${new Date(order.timestamp).toLocaleTimeString()}</small>
                                                </div>
                                                <ul class="list-unstyled mb-3">${itemsHtml}</ul>
                                                <div class="d-flex justify-content-end gap-2">
                                                    ${status === 'Preparing' ? `<button class="btn btn-sm btn-outline-warning bot-action-btn" data-order-id="${order.id}" data-action="move-to-new">Back</button>` : ''}
                                                    ${status === 'Ready' ? `<button class="btn btn-sm btn-outline-warning bot-action-btn" data-order-id="${order.id}" data-action="move-to-preparing">Back</button>` : ''}
                                                    ${actionButton}
                                                </div>
                                            </div>
                                        `
                                    }).join('') || `<p class="text-slate-400 text-center p-5">No orders</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                }

                const content = `
                    <h1 class="text-3xl fw-bold text-white mb-4">Bar Orders (BOT)</h1>
                    <div class="row" style="min-height: 75vh;">${columnsHtml}</div>
                `;
                 $('#main-content').html(content);
            }
            
            function renderInventoryPage() {
                const content = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="text-3xl fw-bold text-white mb-0">Inventory Management</h1>
                        <button class="btn btn-success d-flex align-items-center" id="add-inventory-item-btn">
                            <i class="bi bi-plus-circle me-2"></i> Add Ingredient
                        </button>
                    </div>

                    <ul class="nav nav-pills mb-3" id="inventoryTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="kitchen-tab" data-bs-toggle="tab" data-bs-target="#kitchen-tab-pane" type="button" role="tab" aria-controls="kitchen-tab-pane" aria-selected="true">Kitchen</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bar-tab" data-bs-toggle="tab" data-bs-target="#bar-tab-pane" type="button" role="tab" aria-controls="bar-tab-pane" aria-selected="false">Bar</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-tab-pane" type="button" role="tab" aria-controls="general-tab-pane" aria-selected="false">General</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="inventoryTabContent">
                        <div class="tab-pane fade show active" id="kitchen-tab-pane" role="tabpanel" aria-labelledby="kitchen-tab">
                            <div class="mb-3"><input type="text" id="kitchen-inventory-search" class="form-control form-control-dark inventory-search" data-category="kitchen" placeholder="Search kitchen ingredients..."></div>
                            ${createInventoryTableShell('kitchen')}
                        </div>
                        <div class="tab-pane fade" id="bar-tab-pane" role="tabpanel" aria-labelledby="bar-tab">
                            <div class="mb-3"><input type="text" id="bar-inventory-search" class="form-control form-control-dark inventory-search" data-category="bar" placeholder="Search bar ingredients..."></div>
                            ${createInventoryTableShell('bar')}
                        </div>
                        <div class="tab-pane fade" id="general-tab-pane" role="tabpanel" aria-labelledby="general-tab">
                            <div class="mb-3"><input type="text" id="general-inventory-search" class="form-control form-control-dark inventory-search" data-category="general" placeholder="Search general items..."></div>
                            ${createInventoryTableShell('general')}
                        </div>
                    </div>
                `;
                $('#main-content').html(content);

                // Initial population
                updateInventoryTable('kitchen');
                updateInventoryTable('bar');
                updateInventoryTable('general');

                // Restore active tab
                const activeTabId = localStorage.getItem('activeInventoryTab');
                if (activeTabId) {
                    const triggerEl = document.querySelector(`#inventoryTab button[data-bs-target="${activeTabId}"]`);
                    if(triggerEl) {
                        const tab = new bootstrap.Tab(triggerEl);
                        tab.show();
                    }
                }
            }

            function createInventoryTableShell(category) {
                return `
                    <div class="data-card rounded-4 shadow overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead class="text-uppercase small">
                                    <tr>
                                        <th class="p-3">Ingredient</th>
                                        <th class="p-3">Unit</th>
                                        <th class="p-3 text-end">Stock</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Supplier</th>
                                        <th class="p-3 text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="${category}-inventory-body"></tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            function getInventoryTableRows(category, items) {
                if (!items || items.length === 0) {
                    return '<tr><td colspan="6" class="text-center p-4">No ingredients found.</td></tr>';
                }
                return items.map(item => `
                    <tr class="align-middle">
                        <td class="p-3 fw-medium text-white">${item.name}</td>
                        <td class="p-3">${item.unit}</td>
                        <td class="p-3 text-end font-monospace">${item.stock}</td>
                        <td class="p-3">
                            ${item.stock > item.lowStockThreshold 
                                ? `<span class="badge bg-success-subtle text-success-emphasis rounded-pill">In Stock</span>`
                                : `<span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Low Stock</span>`
                            }
                        </td>
                        <td class="p-3">${item.supplier || 'N/A'}</td>
                        <td class="p-3 text-end">
                            <button class="btn btn-sm btn-outline-info restock-btn" data-item-id="${item.id}" data-category="${category}">Restock</button>
                            <button class="btn btn-sm btn-outline-primary ms-2 edit-inventory-item-btn" data-item-id="${item.id}" data-category="${category}">Edit</button>
                            <button class="btn btn-sm btn-outline-danger ms-2 delete-inventory-item-btn" data-item-id="${item.id}" data-category="${category}">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            function updateInventoryTable(category) {
                const searchTerm = $(`#${category}-inventory-search`).val()?.toLowerCase() || '';
                const filteredItems = state.inventory[category].filter(item => item.name.toLowerCase().includes(searchTerm));
                const tableRowsHtml = getInventoryTableRows(category, filteredItems);
                $(`#${category}-inventory-body`).html(tableRowsHtml);
            }

            function renderMenuManagementPage() {
                const content = `
                     <div class="d-flex justify-content-between align-items-center mb-4">
                         <h1 class="text-3xl fw-bold text-white mb-0">Menu Management</h1>
                         <button class="btn btn-success d-flex align-items-center" id="add-menu-item-btn">
                             <i class="bi bi-plus-circle me-2"></i> Add New Item
                         </button>
                     </div>
                    <div class="mb-4">
                        <input type="text" id="menu-search-input" class="form-control form-control-dark" placeholder="Search menu items...">
                    </div>
                    <div id="menu-list-container"></div>
                `;
                $('#main-content').html(content);
                renderFilteredMenuList(); // Initial render of the list
            }

            function renderFilteredMenuList() {
                const searchTerm = $('#menu-search-input').val()?.toLowerCase() || '';
                let menuHtml = '';
                let foundItems = false;

                for (const category in state.menu) {
                    const filteredItems = state.menu[category].filter(item => 
                        item.name.toLowerCase().includes(searchTerm)
                    );

                    if (filteredItems.length > 0) {
                        foundItems = true;
                        menuHtml += `
                            <div class="menu-category-card rounded-4 mb-4">
                                <h3 class="fs-5 fw-bold text-white p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
                                    ${category}
                                    <button class="btn btn-sm btn-outline-danger remove-category-btn" data-category="${category}"><i class="bi bi-trash"></i></button>
                                </h3>
                                <div>
                                    ${filteredItems.map(item => `
                                        <div class="menu-item-row p-3 d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-bold text-white">${item.name}</div>
                                                <div class="text-slate-400 small">$${item.price.toFixed(2)}</div>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary me-2 edit-menu-item-btn" data-item-id="${item.id}"><i class="bi bi-pencil"></i> Edit</button>
                                                <button class="btn btn-sm btn-outline-danger remove-menu-item-btn" data-item-id="${item.id}"><i class="bi bi-trash"></i> Remove</button>
                                            </div>
                                    </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }

                if (!foundItems && searchTerm) {
                    menuHtml = '<div class="data-card p-4 rounded-4 text-center"><p class="text-slate-400 mb-0">No menu items found matching your search.</p></div>';
                }

                $('#menu-list-container').html(menuHtml);
            }


            function renderUserManagementPage() {
                const userCardsHtml = Object.values(state.users).map(user => `
                    <div class="col-md-6 col-lg-4">
                        <div class="user-card p-3 rounded-4 d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="fs-6 fw-bold text-white mb-0">${user.name}</h3>
                                <p class="text-slate-400 mb-0">${user.role}</p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2 edit-user-btn" data-user-id="${user.id}">Edit</button>
                                <button class="btn btn-sm btn-outline-danger remove-user-btn" data-user-id="${user.id}">Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                const content = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="text-3xl fw-bold text-white mb-0">User Management</h1>
                        <button class="btn btn-success d-flex align-items-center" id="add-user-btn">
                            <i class="bi bi-plus-circle me-2"></i> Add New User
                        </button>
                    </div>
                    <div class="row g-3">
                        ${userCardsHtml}
                    </div>
                `;
                $('#main-content').html(content);
            }

            function renderReportsPage() {
                 const content = `
                    <h1 class="text-3xl fw-bold text-white mb-4">Reports</h1>
                    <ul class="nav nav-tabs" id="reportTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link report-tab-btn ${state.report.activeReport === 'sales' ? 'active' : ''}" id="sales-report-tab" data-bs-toggle="tab" data-bs-target="#sales-report-pane" type="button" role="tab" data-report="sales">Sales Report</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link report-tab-btn ${state.report.activeReport === 'inventory' ? 'active' : ''}" id="inventory-report-tab" data-bs-toggle="tab" data-bs-target="#inventory-report-pane" type="button" role="tab" data-report="inventory">Inventory Report</button>
                        </li>
                    </ul>
                    <div class="tab-content p-4" id="reportTabContent">
                        <div class="tab-pane fade ${state.report.activeReport === 'sales' ? 'show active' : ''}" id="sales-report-pane" role="tabpanel"></div>
                        <div class="tab-pane fade ${state.report.activeReport === 'inventory' ? 'show active' : ''}" id="inventory-report-pane" role="tabpanel"></div>
                    </div>
                `;
                $('#main-content').html(content);
                
                if (state.report.activeReport === 'sales') {
                    renderSalesReport();
                } else {
                    renderInventoryReport();
                }
            }

            function renderSalesReport() {
                const uniqueYears = [...new Set(state.orders.map(o => new Date(o.timestamp).getFullYear()))].sort((a,b) => b-a);
                const yearOptions = uniqueYears.map(y => `<option value="${y}" ${y === state.report.year ? 'selected' : ''}>${y}</option>`).join('');
                const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
                const monthOptions = monthNames.map((m, i) => `<option value="${i}" ${i === state.report.month ? 'selected' : ''}>${m}</option>`).join('');

                const salesContent = `
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h2 class="fs-5 fw-bold text-white mb-0">Sales Over Time</h2>
                        <div class="d-flex align-items-center gap-2" id="report-filters">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary report-range-btn ${state.report.range === '7days' ? 'active' : ''}" data-range="7days">Last 7 Days</button>
                            </div>
                            <select class="form-select form-select-sm form-control-dark" id="report-year-select" style="width: 120px;">
                                ${yearOptions}
                            </select>
                            <select class="form-select form-select-sm form-control-dark" id="report-month-select" style="width: 150px;">
                                <option value="all">All Months</option>
                                ${monthOptions}
                            </select>
                        </div>
                   </div>
                   <div style="position: relative; height:60vh">
                       <canvas id="salesChart"></canvas>
                   </div>
                `;
                $('#sales-report-pane').html(salesContent);
                 $('#report-year-select').val(state.report.year);
                $('#report-month-select').val(state.report.month);
                createSalesChart();
            }

             function renderInventoryReport() {
                // Get current filter values before re-rendering
                const nameFilter = $('#inventory-report-search').val()?.toLowerCase() || '';
                const categoryFilter = $('#inventory-report-category-filter').val() || '';
                const statusFilter = $('#inventory-report-status-filter').val() || '';

                let allItems = [...state.inventory.kitchen, ...state.inventory.bar, ...state.inventory.general];
                
                // Filtering logic
                if (nameFilter) {
                    allItems = allItems.filter(item => item.name.toLowerCase().includes(nameFilter));
                }
                if (categoryFilter) {
                    const categoryMap = { 'kitchen': state.inventory.kitchen, 'bar': state.inventory.bar, 'general': state.inventory.general };
                    const categoryItems = categoryMap[categoryFilter].map(i => i.id);
                    allItems = allItems.filter(item => categoryItems.includes(item.id));
                }
                if (statusFilter) {
                    if (statusFilter === 'low') {
                        allItems = allItems.filter(item => item.stock <= item.lowStockThreshold && item.stock > 0);
                    } else if (statusFilter === 'out') {
                        allItems = allItems.filter(item => item.stock === 0);
                    } else if (statusFilter === 'in_stock') {
                         allItems = allItems.filter(item => item.stock > item.lowStockThreshold);
                    }
                }

                // Calculate stats
                const fullInventory = [...state.inventory.kitchen, ...state.inventory.bar, ...state.inventory.general];
                const lowStockCount = fullInventory.filter(i => i.stock <= i.lowStockThreshold && i.stock > 0).length;
                const outOfStockCount = fullInventory.filter(i => i.stock === 0).length;
                const totalValue = fullInventory.reduce((sum, item) => sum + (item.cost * item.stock), 0);
                
                const tableRows = getInventoryTableRows('report', allItems); // Reuse the same row builder

                const inventoryContent = `
                     <div class="row g-4 mb-4">
                        <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow">
                                <p class="text-slate-400 mb-1">Total Items</p>
                                <p class="fs-2 fw-bold text-white mb-0">${fullInventory.length}</p>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3">
                             <div class="stat-card p-4 rounded-4 shadow">
                                <p class="text-slate-400 mb-1">Low Stock Items</p>
                                <p class="fs-2 fw-bold text-danger mb-0">${lowStockCount}</p>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3">
                             <div class="stat-card p-4 rounded-4 shadow">
                                <p class="text-slate-400 mb-1">Out of Stock</p>
                                <p class="fs-2 fw-bold text-danger mb-0">${outOfStockCount}</p>
                            </div>
                        </div>
                         <div class="col-md-6 col-xl-3">
                             <div class="stat-card p-4 rounded-4 shadow">
                                <p class="text-slate-400 mb-1">Total Inventory Value</p>
                                <p class="fs-2 fw-bold text-white mb-0">$${totalValue.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>

                    <div class="data-card p-3 rounded-4 shadow mb-4">
                         <div class="row g-2 align-items-end">
                             <div class="col-md-5">
                                 <label for="inventory-report-search" class="form-label small">Search by Name</label>
                                 <input type="text" id="inventory-report-search" class="form-control form-control-dark" placeholder="e.g., Pizza Dough">
                             </div>
                             <div class="col-md-4">
                                 <label for="inventory-report-category-filter" class="form-label small">Filter by Category</label>
                                 <select id="inventory-report-category-filter" class="form-select form-select-dark">
                                     <option value="">All Categories</option>
                                     <option value="kitchen">Kitchen</option>
                                     <option value="bar">Bar</option>
                                     <option value="general">General</option>
                                 </select>
                             </div>
                             <div class="col-md-3">
                                 <label for="inventory-report-status-filter" class="form-label small">Filter by Status</label>
                                 <select id="inventory-report-status-filter" class="form-select form-select-dark">
                                     <option value="">All Statuses</option>
                                     <option value="in_stock">In Stock</option>
                                     <option value="low">Low Stock</option>
                                     <option value="out">Out of Stock</option>
                                 </select>
                             </div>
                         </div>
                     </div>
                     ${createInventoryTableShell('inventory-report')}
                `;

                $('#inventory-report-pane').html(inventoryContent);
                $('#inventory-report-body').html(tableRows);
                 // Preserve filter values
                $('#inventory-report-search').val(nameFilter);
                $('#inventory-report-category-filter').val(categoryFilter);
                $('#inventory-report-status-filter').val(statusFilter);
            }


            function createSalesChart() {
                if (state.salesChart) {
                    state.salesChart.destroy();
                }
                const ctx = document.getElementById('salesChart')?.getContext('2d');
                if (!ctx) return;

                const today = new Date('2025-10-08T10:53:00');
                let labels = [];
                let dataPoints = [];

                const completedOrders = state.orders.filter(o => o.status === 'completed');

                switch(state.report.range) {
                    case 'custom':
                        const reportYear = state.report.year;
                        const reportMonth = state.report.month;

                        if (reportMonth === 'all') { // Yearly view
                            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            dataPoints = Array(12).fill(0);
                            completedOrders.forEach(order => {
                                const orderDate = new Date(order.timestamp);
                                if (orderDate.getFullYear() === reportYear) {
                                    const month = orderDate.getMonth();
                                    dataPoints[month] += order.total;
                                }
                            });
                        } else { // Monthly view
                            const monthIndex = parseInt(reportMonth);
                            const daysInMonth = new Date(reportYear, monthIndex + 1, 0).getDate();
                            labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                            dataPoints = Array(daysInMonth).fill(0);
                            completedOrders.forEach(order => {
                                const orderDate = new Date(order.timestamp);
                                if (orderDate.getFullYear() === reportYear && orderDate.getMonth() === monthIndex) {
                                    const day = orderDate.getDate() - 1;
                                    dataPoints[day] += order.total;
                                }
                            });
                        }
                        break;
                    
                    case '7days':
                    default:
                        labels = Array.from({ length: 7 }, (_, i) => {
                            const d = new Date(today);
                            d.setDate(today.getDate() - i);
                            return d.toLocaleDateString('en-US', { weekday: 'short' });
                        }).reverse();
                        dataPoints = Array(7).fill(0);
                        const sevenDaysAgo = new Date(today);
                        sevenDaysAgo.setDate(today.getDate() - 6);
                        sevenDaysAgo.setHours(0, 0, 0, 0);

                        completedOrders.forEach(order => {
                            const orderDate = new Date(order.timestamp);
                            if (orderDate >= sevenDaysAgo && orderDate <= today) {
                                const todayStart = new Date(today);
                                todayStart.setHours(0, 0, 0, 0);
                                const orderDateStart = new Date(orderDate);
                                orderDateStart.setHours(0, 0, 0, 0);

                                const diffTime = Math.abs(todayStart - orderDateStart);
                                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                                const index = 6 - diffDays;
                                if (index >= 0 && index < 7) {
                                    dataPoints[index] += order.total;
                                }
                            }
                        });
                        break;
                }

                const data = {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales ($)',
                        data: dataPoints,
                        fill: false,
                        borderColor: 'rgb(16, 185, 129)',
                        tension: 0.1
                    }]
                };
                state.salesChart = new Chart(ctx, { 
                    type: 'line', 
                    data: data, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // --- MODAL RENDER FUNCTIONS ---
            
            function openOrderModal(tableId, orderType = 'Dining') {
                state.activeModalTableId = tableId;
                const title = tableId ? `Order for ${state.tables.find(t=>t.id === tableId).name}` : `New ${orderType} Order`;
                $('#orderModalLabel').text(title);

                // Reset or load active order
                state.activeOrder = {
                    orderType: orderType,
                    deliveryMethod: null,
                    customerName: '',
                    customerContact: '',
                    customerAddress: '',
                    referenceNumber: '',
                    items: tableId ? JSON.parse(JSON.stringify(state.tables.find(t=>t.id === tableId).order)) : []
                };

                const isOrderLocked = state.kitchenOrders.some(ko => ko.tableId === tableId && (ko.status === 'preparing' || ko.status === 'ready'));

                // Render Menu, Customer Details, and Order Summary
                renderCustomerDetails();
                renderMenu();
                updateOrderSummary(state.activeOrder.items, isOrderLocked);
                
                $('#orderModal').modal('show');
            }

            function renderMenu() {
                 const menuContainer = $('#menu-container');
                 menuContainer.empty();
                 $.each(state.menu, (category, items) => {
                     const itemsHtml = items.map(item => `
                         <div class="col">
                            <button class="btn menu-item-btn w-100 text-start p-3 rounded-3 menu-item" data-item-id="${item.id}">
                                <div class="fw-semibold">${item.name}</div>
                                <div class="small text-slate-300">$${item.price.toFixed(2)}</div>
                            </button>
                         </div>
                     `).join('');
                     menuContainer.append(`
                         <h4 class="text-emerald fw-bold fs-6 mb-2">${category}</h4>
                         <div class="row row-cols-1 row-cols-sm-2 g-2 mb-3">${itemsHtml}</div>
                     `);
                 });
            }
            
            function renderCustomerDetails() {
                const detailsSection = $('#customer-details-section');
                let detailsHtml = `
                    <div class="row g-2 mb-3">
                        <div class="col-sm-6">
                            <label class="form-label small">Order Type</label>
                            <select id="order-type-select" class="form-select form-select-dark" ${state.activeModalTableId !== null ? 'disabled' : ''}>
                                <option value="Dining" ${state.activeOrder.orderType === 'Dining' ? 'selected' : ''}>Dining</option>
                                <option value="Take Away" ${state.activeOrder.orderType === 'Take Away' ? 'selected' : ''}>Take Away</option>
                                <option value="Delivery" ${state.activeOrder.orderType === 'Delivery' ? 'selected' : ''}>Delivery</option>
                            </select>
                        </div>
                        <div class="col-sm-6" id="delivery-method-wrapper" style="display: ${state.activeOrder.orderType === 'Delivery' ? 'block' : 'none'};">
                             <label class="form-label small">Delivery Method</label>
                             <select id="delivery-method-select" class="form-select form-select-dark">
                                 <option value="uber" ${state.activeOrder.deliveryMethod === 'uber' ? 'selected' : ''}>Uber</option>
                                 <option value="pickme" ${state.activeOrder.deliveryMethod === 'pickme' ? 'selected' : ''}>PickMe</option>
                                 <option value="self" ${state.activeOrder.deliveryMethod === 'self' ? 'selected' : ''}>Self Delivery</option>
                             </select>
                        </div>
                    </div>
                `;
                if (state.activeOrder.orderType === 'Take Away' || state.activeOrder.orderType === 'Delivery') {
                    detailsHtml += `
                         <div class="row g-2">
                             <div class="col-md-6">
                                 <label class="form-label small">Customer Name</label>
                                 <input type="text" id="customer-name-input" class="form-control form-control-dark" value="${state.activeOrder.customerName}">
                             </div>
                             <div class="col-md-6">
                                 <label class="form-label small">Contact Number</label>
                                 <input type="tel" id="customer-contact-input" class="form-control form-control-dark" value="${state.activeOrder.customerContact || ''}">
                             </div>
                             ${state.activeOrder.orderType === 'Delivery' ? `
                             <div class="col-12">
                                 <label class="form-label small">Delivery Address</label>
                                 <input type="text" id="customer-address-input" class="form-control form-control-dark" value="${state.activeOrder.customerAddress}">
                             </div>
                              <div class="col-12">
                                 <label class="form-label small">Reference Number</label>
                                 <input type="text" id="reference-number-input" class="form-control form-control-dark" placeholder="e.g., Uber Eats #12345" value="${state.activeOrder.referenceNumber || ''}">
                             </div>` : ''}
                         </div>
                    `;
                }
                detailsSection.html(detailsHtml);
            }

            function updateOrderSummary(currentItems, isOrderLocked = false) {
                const orderItemsContainer = $('#current-order-items');
                const table = state.activeModalTableId ? state.tables.find(t => t.id === state.activeModalTableId) : null;
                const originalOrderMap = table ? new Map(table.order.map(i => [i.id, i.quantity])) : new Map();

                if (!currentItems || currentItems.length === 0) {
                    orderItemsContainer.html('<p class="text-slate-400 text-center pt-5">No items added yet.</p>');
                } else {
                    orderItemsContainer.empty();
                    currentItems.forEach(item => {
                        const originalQuantity = originalOrderMap.get(item.id) || 0;
                        const isItemLocked = isOrderLocked && originalQuantity > 0;
                        const canDecrease = !isItemLocked || (isItemLocked && item.quantity > originalQuantity);
                        
                        let modifiersHtml = '';
                        if (item.modifiers && item.modifiers.length > 0) {
                             modifiersHtml = `<ul class="list-unstyled mb-0">
                                ${item.modifiers.map(mod => `<li class="modifier-item">+ ${mod.name} ($${mod.price.toFixed(2)})</li>`).join('')}
                             </ul>`;
                        }

                        orderItemsContainer.append(`
                            <div class="order-item p-2 rounded-3 mb-2">
                               <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold text-white">${item.name}</div>
                                        <div class="small text-slate-300">$${item.price.toFixed(2)}</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <button class="btn btn-sm rounded-circle quantity-btn" data-item-id="${item.customId || item.id}" data-change="-1" ${!canDecrease ? 'disabled' : ''}>-</button>
                                        <span class="fw-bold text-white" style="min-width: 20px; text-align: center;">${item.quantity}</span>
                                        <button class="btn btn-sm rounded-circle quantity-btn" data-item-id="${item.customId || item.id}" data-change="1">+</button>
                                    </div>
                               </div>
                               ${modifiersHtml}
                            </div>
                        `);
                    });
                }
                
                const total = currentItems.reduce((sum, item) => {
                    const modifiersTotal = item.modifiers ? item.modifiers.reduce((modSum, mod) => modSum + mod.price, 0) : 0;
                    return sum + (item.price + modifiersTotal) * item.quantity;
                }, 0);
                $('#order-total').text(`$${total.toFixed(2)}`);
                
                const mainButton = $('#place-order-btn');
                mainButton.prop('disabled', currentItems.length === 0);
                mainButton.text(table && table.order.length > 0 ? 'Update Order' : 'Place Order');

                const footer = $('#order-modal-footer');
                footer.find('#cancel-order-btn').remove();
                const isCancellable = table && table.order.length > 0 && !isOrderLocked;

                if (isCancellable) {
                    footer.append('<button id="cancel-order-btn" class="btn btn-danger w-100 fw-bold mt-2">Cancel Entire Order</button>');
                }
            }

            function openBillingModal(tableId) {
                state.activeModalTableId = tableId;
                const table = state.tables.find(t => t.id === tableId);
                let allItems = table.order; // In this new model, table.order IS the full order.
                
                const subtotal = allItems.reduce((sum, item) => {
                    const modifiersTotal = item.modifiers ? item.modifiers.reduce((modSum, mod) => modSum + mod.price, 0) : 0;
                    return sum + (item.price + modifiersTotal) * item.quantity;
                }, 0);
                
                const tax = subtotal * 0.08;
                const serviceCharge = subtotal * 0.10;
                const total = subtotal + tax + serviceCharge;

                $('#billingModalLabel').text(`Bill for ${table.name}`);
                
                $('#billing-items-summary').html(
                    allItems.map(item => {
                        const modifiersHtml = item.modifiers && item.modifiers.length > 0
                            ? item.modifiers.map(mod => `<div class="modifier-item">+ ${mod.name} ($${mod.price.toFixed(2)})</div>`).join('')
                            : '';
                        const itemTotal = (item.price + (item.modifiers ? item.modifiers.reduce((s, m) => s + m.price, 0) : 0)) * item.quantity;
                        
                        return `
                            <div class="d-flex justify-content-between py-1 text-slate-300">
                                <span>${item.name} x ${item.quantity}</span>
                                <span>$${itemTotal.toFixed(2)}</span>
                            </div>
                            ${modifiersHtml}
                        `;
                    }).join('')
                );

                $('#billing-totals-summary').html(`
                    <div class="d-flex justify-content-between text-slate-300"><span>Subtotal:</span> <span>$${subtotal.toFixed(2)}</span></div>
                    <div class="d-flex justify-content-between text-slate-300"><span>Tax (8%):</span> <span>$${tax.toFixed(2)}</span></div>
                    <div class="d-flex justify-content-between text-slate-300"><span>Service Charge (10%):</span> <span>$${serviceCharge.toFixed(2)}</span></div>
                    <hr class="border-secondary">
                    <div class="d-flex justify-content-between text-white fs-4 fw-bold"><span>Total:</span> <span>$${total.toFixed(2)}</span></div>
                `);

                $('#payment-buttons').html(`
                    <button class="btn btn-lg btn-success payment-btn" data-total="${total}">Pay with Card</button>
                    <button class="btn btn-lg btn-primary payment-btn" data-total="${total}">Pay with Cash</button>
                `);

                $('#billingModal').modal('show');
            }


            // --- EVENT HANDLERS ---
            
            // Login
            $('#login-form').on('click', '.login-btn', function() {
                initAudio(); // Initialize AudioContext on first user interaction
                const roleId = $(this).data('role-id');
                state.currentUser = Object.values(state.users).find(u => u.id === roleId);
                
                switch (state.currentUser.role) {
                    case 'Admin':
                    case 'Manager':
                    case 'Cashier':
                        state.currentPage = 'Dashboard';
                        break;
                    case 'Kitchen':
                        state.currentPage = 'Kitchen';
                        break;
                    case 'Bartender':
                        state.currentPage = 'Bar';
                        break;
                    default:
                        state.currentPage = 'Tables';
                }
                render();
            });

            // Logout
            $('body').on('click', '#logout-btn', function() {
                state.currentUser = null;
                render();
            });
            
            // Navigation
            $('body').on('click', '.nav-link[data-page]', function() {
                state.currentPage = $(this).data('page');
                render();
            });
            
            // New Order Buttons
            $('body').on('click', '.new-order-btn', function() {
                const orderType = $(this).data('order-type');
                openOrderModal(null, orderType); // null tableId for non-dining
            });

            // Table Selection
            $('body').on('click', '.table-card', function() {
                const tableId = $(this).data('table-id');
                const table = state.tables.find(t => t.id === tableId);
                const userRole = state.currentUser.role;

                if (table.status === 'billing') {
                     if (userRole === 'Cashier' || userRole === 'Admin' || userRole === 'Manager') {
                         openBillingModal(tableId);
                     } else if (userRole === 'Waiter') {
                         openOrderModal(tableId, 'Dining');
                     }
                      else {
                         Swal.fire({
                             title: 'Billing in Progress',
                             text: `The bill for ${table.name} is ready. The cashier will process the payment.`,
                             icon: 'info'
                         });
                    }
                } else if (table.status === 'available' || table.status === 'occupied') {
                    if (userRole === 'Waiter' || userRole === 'Admin' || userRole === 'Manager') {
                         openOrderModal(tableId, 'Dining');
                    } else {
                         Swal.fire({
                             title: 'Action Not Allowed',
                             text: 'Only Waiters, Managers, or Admins can place or modify orders.',
                             icon: 'warning'
                         });
                    }
                } else {
                     Swal.fire({
                         title: `Table Status: ${table.status}`,
                         text: `${table.name} is currently ${table.status}.`,
                         icon: 'info'
                     });
                }
            });

            // Order Modal: Add Item / Open Customization
            $('#orderModal').on('click', '.menu-item', function() {
                const itemId = $(this).data('item-id');
                const itemData = Object.values(state.menu).flat().find(i => i.id === itemId);

                if (itemData.customizable) {
                    state.itemToCustomize = { ...itemData };
                    $('#customizationModalLabel').text(`Customize ${itemData.name}`);
                    const modifiersContainer = $('#modifiers-container');
                    modifiersContainer.empty();
                    itemData.modifiers.forEach(mod => {
                        modifiersContainer.append(`
                             <div class="form-check">
                                 <input class="form-check-input" type="checkbox" value="${mod.price}" id="mod-${mod.name.replace(/\s+/g, '')}" data-name="${mod.name}">
                                 <label class="form-check-label" for="mod-${mod.name.replace(/\s+/g, '')}">
                                     ${mod.name} <span class="text-muted">(+$${mod.price.toFixed(2)})</span>
                                 </label>
                             </div>
                        `);
                    });
                    const customizationModal = new bootstrap.Modal(document.getElementById('itemCustomizationModal'));
                    customizationModal.show();
                } else {
                     const existingItem = state.activeOrder.items.find(item => item.id === itemId && !item.modifiers);
                     if (existingItem) {
                         existingItem.quantity++;
                     } else {
                         state.activeOrder.items.push({ ...itemData, quantity: 1, customId: Date.now() });
                     }
                     const isOrderLocked = state.kitchenOrders.some(ko => ko.tableId === state.activeModalTableId && (ko.status === 'preparing' || ko.status === 'ready'));
                     updateOrderSummary(state.activeOrder.items, isOrderLocked);
                }
            });

             // Order Modal: Handle Customer Details Change
            $('#orderModal').on('change', '#order-type-select', function() {
                state.activeOrder.orderType = $(this).val();
                renderCustomerDetails();
            });


             // Customization Modal: Add Item
            $('#add-customized-item-btn').on('click', function() {
                const selectedModifiers = [];
                $('#customization-form .form-check-input:checked').each(function() {
                    selectedModifiers.push({
                        name: $(this).data('name'),
                        price: parseFloat($(this).val())
                    });
                });
                
                const customizedItem = {
                    ...state.itemToCustomize,
                    quantity: 1,
                    modifiers: selectedModifiers,
                    customId: Date.now() // Unique ID for each customized item instance
                };

                state.activeOrder.items.push(customizedItem);
                const isOrderLocked = state.kitchenOrders.some(ko => ko.tableId === state.activeModalTableId && (ko.status === 'preparing' || ko.status === 'ready'));
                updateOrderSummary(state.activeOrder.items, isOrderLocked);
                
                bootstrap.Modal.getInstance(document.getElementById('itemCustomizationModal')).hide();
            });

            
            // Order Modal: Update Quantity
            $('#orderModal').on('click', '.quantity-btn', function() {
                const itemId = $(this).data('item-id');
                const change = $(this).data('change');
                const itemInOrder = state.activeOrder.items.find(item => (item.customId || item.id) === itemId);
                const isOrderLocked = state.kitchenOrders.some(ko => ko.tableId === state.activeModalTableId && (ko.status === 'preparing' || ko.status === 'ready'));

                if (itemInOrder) {
                    const table = state.activeModalTableId ? state.tables.find(t => t.id === state.activeModalTableId) : null;
                    const originalItem = table ? table.order.find(i => (i.customId || i.id) === itemId) : null;
                    const originalQuantity = originalItem ? originalItem.quantity : 0;

                    if (change < 0 && isOrderLocked && itemInOrder.quantity <= originalQuantity) {
                        showToast("Cannot reduce quantity of an item being prepared.", "danger");
                        return;
                    }

                    itemInOrder.quantity += change;
                    if (itemInOrder.quantity <= 0) {
                        state.activeOrder.items = state.activeOrder.items.filter(i => (i.customId || i.id) !== itemId);
                    }
                }
                updateOrderSummary(state.activeOrder.items, isOrderLocked);
            });

            // Order Modal: Place or Update Order
            $('#place-order-btn').on('click', function() {
                const tableId = state.activeModalTableId;
                const table = tableId ? state.tables.find(t => t.id === tableId) : null;
                
                // Capture details from form into activeOrder object
                Object.assign(state.activeOrder, {
                    customerName: $('#customer-name-input').val() || '',
                    customerContact: $('#customer-contact-input').val() || '',
                    customerAddress: $('#customer-address-input').val() || '',
                    deliveryMethod: $('#delivery-method-select').val() || null,
                    referenceNumber: $('#reference-number-input').val() || ''
                });

                const allItems = state.activeOrder.items;

                const kitchenItems = allItems.filter(item => !['Beverages', 'Liqueur'].includes(getCategoryByItemId(item.id)));
                const barItems = allItems.filter(item => ['Beverages', 'Liqueur'].includes(getCategoryByItemId(item.id)));

                const processOrder = (items, orderQueue, name) => {
                    if (items.length > 0) {
                        const newTicket = {
                            id: Date.now() + Math.random(),
                            tableId: table ? table.id : null,
                            tableName: table ? table.name : `${state.activeOrder.orderType} #${state.orders.length + 1}`,
                            items: items,
                            status: 'new',
                            timestamp: new Date().toISOString(),
                            ...state.activeOrder
                        };
                        orderQueue.unshift(newTicket);
                        showToast(`New items sent to ${name}.`);
                    }
                };
                
                if (table) { // Dining order update logic
                    const kitchenDiff = calculateOrderDifference(table.order, kitchenItems);
                    const barDiff = calculateOrderDifference(table.order, barItems);
                    
                    processOrder(kitchenDiff, state.kitchenOrders, "Kitchen");
                    processOrder(barDiff, state.barOrders, "Bar");

                    table.order = [...allItems];
                    if (allItems.length > 0) {
                         table.status = 'occupied';
                    }
                } else { // New Take Away or Delivery Order
                    processOrder(kitchenItems, state.kitchenOrders, "Kitchen");
                    processOrder(barItems, state.barOrders, "Bar");
                }

                if (kitchenItems.length > 0 || barItems.length > 0) {
                    playSound('new-order');
                }
                
                $('#orderModal').modal('hide');
                render();
            });
            
            // Order Modal: Cancel Order
            $('body').on('click', '#cancel-order-btn', function() {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This will cancel the entire order for this table.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, cancel it!',
                    cancelButtonText: 'No, keep it'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const tableId = state.activeModalTableId;
                        const table = state.tables.find(t => t.id === tableId);
                        
                        // Remove the corresponding 'new' KOT from the kitchen list
                        state.kitchenOrders = state.kitchenOrders.filter(ko => !(ko.tableId === tableId && ko.status === 'new'));
                        
                        table.order = [];
                        table.status = 'available';

                        $('#orderModal').modal('hide');
                        Swal.fire('Cancelled!', `Order for ${table.name} has been cancelled.`, 'success');
                        render();
                    }
                });
            });


            // Billing Modal: Process Payment
            $('#billingModal').on('click', '.payment-btn', function() {
                const total = $(this).data('total');
                const table = state.tables.find(t => t.id === state.activeModalTableId);
                
                // NOTE: Automatic stock deduction is removed as we move to ingredient-based inventory.
                // This would require a recipe system to be implemented.
                
                // Create completed order record
                state.orders.push({
                    id: Date.now(),
                    tableId: table.id,
                    tableName: table.name,
                    items: table.order, // Contains full item details with modifiers
                    total: parseFloat(total),
                    status: 'completed',
                    timestamp: new Date().toISOString(),
                });
                
                // Reset table
                table.status = 'available';
                table.order = [];

                $('#billingModal').modal('hide');
                showToast('Payment successful! Table is now available.');
                render();
            });

            // Kitchen: Update Order Status
            $('body').on('click', '.kot-action-btn, .bot-action-btn', function() {
                const orderId = $(this).data('order-id');
                const action = $(this).data('action');
                const isKitchen = $(this).hasClass('kot-action-btn');
                const orderQueue = isKitchen ? state.kitchenOrders : state.barOrders;
                const order = orderQueue.find(o => o.id === orderId);

                if (!order) return;

                switch (action) {
                    case 'served':
                        const index = orderQueue.findIndex(o => o.id === orderId);
                        if(index > -1) orderQueue.splice(index, 1);
                        
                        const table = state.tables.find(t => t.id === order.tableId);
                        if (table) {
                            const hasPendingKitchen = state.kitchenOrders.some(ko => ko.tableId === table.id);
                            const hasPendingBar = state.barOrders.some(bo => bo.tableId === table.id);
                            if (!hasPendingKitchen && !hasPendingBar) {
                                table.status = 'billing';
                                playSound('billing-ready');
                            }
                        }
                        showToast(`${order.tableName}'s ${isKitchen ? 'food' : 'drinks'} have been served.`);
                        break;
                    case 'ready':
                        Swal.fire({
                            title: `Is the ${isKitchen ? 'food' : 'drink'} order ready?`,
                            text: `Confirm items for ${order.tableName} are ready.`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: "Yes, it's ready!",
                            cancelButtonText: 'Not yet'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                order.status = 'ready';
                                playSound('order-ready');
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'info',
                                    title: `${isKitchen ? 'Food' : 'Drinks'} for ${order.tableName} is ready!`,
                                    showConfirmButton: false,
                                    timer: 5000,
                                    timerProgressBar: true
                                });
                                render();
                            }
                        });
                        return; // Prevent default render
                    case 'move-to-new':
                        order.status = 'new';
                        break;
                    case 'move-to-preparing':
                        order.status = 'preparing';
                        break;
                    default: // 'preparing'
                        order.status = action;
                        break;
                }
                render();
            });

            // --- INVENTORY MANAGEMENT (NEW) ---

            function openInventoryModal(item = null, category = 'kitchen') {
                $('#inventory-form')[0].reset();
                if (item) {
                    $('#inventoryModalLabel').text('Edit Ingredient');
                    $('#inventory-item-id').val(item.id);
                    $('#inventory-item-original-category').val(category);
                    $('#inventory-item-name').val(item.name);
                    $('#inventory-item-category').val(category);
                    $('#inventory-item-unit').val(item.unit);
                    $('#inventory-item-stock').val(item.stock);
                    $('#inventory-item-low-stock').val(item.lowStockThreshold);
                    $('#inventory-item-supplier').val(item.supplier);
                    $('#inventory-item-cost').val(item.cost);
                } else {
                    $('#inventoryModalLabel').text('Add Ingredient');
                    $('#inventory-item-id').val('');
                    $('#inventory-item-original-category').val('');
                }
                $('#inventoryModal').modal('show');
            }

            $('body').on('click', '#add-inventory-item-btn', function() {
                openInventoryModal();
            });

            $('body').on('click', '.edit-inventory-item-btn', function() {
                const itemId = $(this).data('item-id');
                const category = $(this).data('category');
                const item = state.inventory[category].find(i => i.id === itemId);
                if (item) {
                    openInventoryModal(item, category);
                }
            });

            $('#inventory-form').on('submit', function(e) {
                e.preventDefault();
                const itemId = $('#inventory-item-id').val();
                const originalCategory = $('#inventory-item-original-category').val();
                const newCategory = $('#inventory-item-category').val();

                const itemData = {
                    id: itemId || `item_${Date.now()}`,
                    name: $('#inventory-item-name').val(),
                    unit: $('#inventory-item-unit').val(),
                    stock: parseFloat($('#inventory-item-stock').val()),
                    lowStockThreshold: parseFloat($('#inventory-item-low-stock').val()),
                    supplier: $('#inventory-item-supplier').val(),
                    cost: parseFloat($('#inventory-item-cost').val()) || 0
                };

                if (itemId) { // Editing
                    // Remove from original category if category has changed
                    if (originalCategory && originalCategory !== newCategory) {
                        state.inventory[originalCategory] = state.inventory[originalCategory].filter(i => i.id !== itemId);
                    } else { // Just update in place
                         const itemIndex = state.inventory[originalCategory].findIndex(i => i.id === itemId);
                         if (itemIndex > -1) state.inventory[originalCategory].splice(itemIndex, 1);
                    }
                    state.inventory[newCategory].push(itemData);
                    showToast('Ingredient updated successfully!');
                } else { // Adding
                    state.inventory[newCategory].push(itemData);
                    showToast('Ingredient added successfully!');
                }

                $('#inventoryModal').modal('hide');
                renderInventoryPage();
            });

            $('body').on('click', '.delete-inventory-item-btn', function() {
                const itemId = $(this).data('item-id');
                const category = $(this).data('category');
                const item = state.inventory[category].find(i => i.id === itemId);

                Swal.fire({
                    title: 'Are you sure?',
                    text: `You are about to remove ${item.name}. This cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove it!',
                }).then((result) => {
                    if (result.isConfirmed) {
                        state.inventory[category] = state.inventory[category].filter(i => i.id !== itemId);
                        Swal.fire('Removed!', `${item.name} has been removed.`, 'success');
                        renderInventoryPage();
                    }
                });
            });

            $('body').on('click', '.restock-btn', function() {
                const itemId = $(this).data('item-id');
                const category = $(this).data('category');
                const item = state.inventory[category].find(i => i.id === itemId);
                if (item) {
                    Swal.fire({
                        title: `Restock ${item.name}`,
                        input: 'number',
                        inputLabel: `Current stock (${item.unit}): ${item.stock}. How many to add?`,
                        inputValue: 10,
                        showCancelButton: true,
                        confirmButtonText: 'Restock',
                    }).then((result) => {
                        if (result.isConfirmed && result.value) {
                             const quantity = parseFloat(result.value);
                             if (quantity > 0) {
                                 item.stock += quantity;
                                 showToast(`${item.name} restocked successfully.`);
                                 renderInventoryPage();
                             }
                        }
                    });
                }
            });
            
            // --- MENU MANAGEMENT ---
            function openMenuItemModal(itemId = null) {
                $('#menu-item-form')[0].reset();
                $('#modifiers-list').empty();
                $('#modifiers-management-section').hide();

                const categorySelect = $('#menu-item-category');
                categorySelect.empty();
                 categorySelect.off('change'); // Detach handler

                Object.keys(state.menu).forEach(cat => {
                    categorySelect.append(`<option value="${cat}">${cat}</option>`);
                });
                categorySelect.append('<option value="new_category" class="text-info">-- Add New Category --</option>');
                
                if (itemId) {
                    let itemToEdit, originalCategory;
                    for (const category in state.menu) {
                        const foundItem = state.menu[category].find(item => item.id === itemId);
                        if (foundItem) {
                            itemToEdit = foundItem;
                            originalCategory = category;
                            break;
                        }
                    }

                    if (itemToEdit) {
                        $('#menuItemModalLabel').text('Edit Menu Item');
                        $('#menu-item-id').val(itemToEdit.id);
                        $('#menu-item-name').val(itemToEdit.name);
                        $('#menu-item-price').val(itemToEdit.price.toFixed(2));
                        $('#menu-item-stock').val(itemToEdit.stock); // This field is now for informational/initial setup purposes only
                        $('#menu-item-category').val(originalCategory);

                        if (itemToEdit.customizable) {
                            $('#menu-item-customizable').prop('checked', true).trigger('change');
                            if (itemToEdit.modifiers) {
                                itemToEdit.modifiers.forEach(mod => addModifierInput(mod));
                            }
                        }
                    }
                } else {
                    $('#menuItemModalLabel').text('Add New Menu Item');
                    $('#menu-item-id').val('');
                }
                 categorySelect.on('change', handleNewCategory); // Re-attach handler
                $('#menuItemModal').modal('show');
            }

            function addModifierInput(modifier = { name: '', price: '' }) {
                $('#modifiers-list').append(`
                    <div class="input-group mb-2">
                        <input type="text" class="form-control form-control-dark modifier-name" placeholder="Modifier Name (e.g., Extra Cheese)" value="${modifier.name}" required>
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control form-control-dark modifier-price" placeholder="Price" step="0.01" min="0" value="${modifier.price}" required>
                        <button class="btn btn-outline-danger remove-modifier-btn" type="button"><i class="bi bi-trash"></i></button>
                    </div>
                `);
            }

            function handleNewCategory() {
                if ($(this).val() === 'new_category') {
                    Swal.fire({
                        title: 'Enter New Category Name',
                        input: 'text',
                        inputPlaceholder: 'e.g., Soups',
                        showCancelButton: true,
                        confirmButtonText: 'Create & Select',
                    }).then((result) => {
                        const categorySelect = $('#menu-item-category');
                        if (result.isConfirmed && result.value) {
                            const newCategoryName = result.value.trim();
                            if (newCategoryName && !state.menu.hasOwnProperty(newCategoryName)) {
                                state.menu[newCategoryName] = [];
                                categorySelect.find('option[value="new_category"]').remove();
                                categorySelect.append(new Option(newCategoryName, newCategoryName, true, true));
                                categorySelect.append('<option value="new_category" class="text-info">-- Add New Category --</option>');
                                categorySelect.val(newCategoryName);
                                showToast(`Category "${newCategoryName}" created.`, 'success');
                            } else {
                                categorySelect.val(state.menu.hasOwnProperty(newCategoryName) ? newCategoryName : '');
                            }
                        } else {
                            categorySelect.prop('selectedIndex', 0);
                        }
                    });
                }
            }
             
            $('body').on('click', '#add-menu-item-btn', () => openMenuItemModal());
            $('body').on('click', '.edit-menu-item-btn', function() { openMenuItemModal($(this).data('item-id')); });

            $('body').on('change', '#menu-item-customizable', function() { $('#modifiers-management-section').toggle(this.checked); });
            $('body').on('click', '#add-modifier-btn', () => addModifierInput());
            $('body').on('click', '.remove-modifier-btn', function() { $(this).closest('.input-group').remove(); });
            
            $('#menu-item-form').on('submit', function(e) {
                e.preventDefault();
                const itemId = parseInt($('#menu-item-id').val()) || null;
                const category = $('#menu-item-category').val();

                if (!category || category === 'new_category') {
                    showToast('Please select or create a valid category.', 'danger');
                    return;
                }

                const isCustomizable = $('#menu-item-customizable').is(':checked');
                const modifiers = [];
                if (isCustomizable) {
                    $('#modifiers-list .input-group').each(function() {
                        const name = $(this).find('.modifier-name').val();
                        const price = parseFloat($(this).find('.modifier-price').val());
                        if (name && !isNaN(price)) {
                            modifiers.push({ name, price });
                        }
                    });
                }

                const itemData = {
                    id: itemId || Date.now(),
                    name: $('#menu-item-name').val(),
                    price: parseFloat($('#menu-item-price').val()),
                    // Note: Stock from this modal is informational for now. Real stock is ingredient-based.
                    customizable: isCustomizable,
                    modifiers: modifiers
                };

                if (itemId) { // Editing
                    for (const cat in state.menu) {
                        const itemIndex = state.menu[cat].findIndex(item => item.id === itemId);
                        if (itemIndex > -1) {
                            state.menu[cat].splice(itemIndex, 1);
                            break;
                        }
                    }
                }
                state.menu[category].push(itemData);
                showToast(`Menu item ${itemId ? 'updated' : 'added'} successfully!`);

                $('#menuItemModal').modal('hide');
                render();
            });
            
            $('body').on('click', '.remove-menu-item-btn', function() {
                const itemId = $(this).data('item-id');
                Swal.fire({
                    title: 'Are you sure?', text: "This will remove the item from the menu.",
                    icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        for (const category in state.menu) {
                            state.menu[category] = state.menu[category].filter(item => item.id !== itemId);
                        }
                        Swal.fire('Deleted!', 'The menu item has been deleted.', 'success');
                        render();
                    }
                });
            });

            $('body').on('click', '.remove-category-btn', function(e) {
                e.stopPropagation();
                const category = $(this).data('category');
                if (state.menu[category] && state.menu[category].length > 0) {
                    Swal.fire('Cannot Delete', 'Please remove all items from this category before deleting it.', 'error');
                    return;
                }
                Swal.fire({
                    title: `Delete '${category}'?`, text: "This action cannot be undone.",
                    icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        delete state.menu[category];
                        Swal.fire('Deleted!', 'The category has been removed.', 'success');
                        render();
                    }
                });
            });

            // --- USER MANAGEMENT ---
            $('body').on('click', '#add-user-btn', function() {
                $('#user-form')[0].reset();
                $('#user-id').val('');
                $('#userModalLabel').text('Add New User');
                $('#userModal').modal('show');
            });
            $('body').on('click', '.edit-user-btn', function() {
                const userId = $(this).data('user-id');
                const user = state.users[userId];
                if(user) {
                    $('#user-id').val(user.id);
                    $('#user-name').val(user.name);
                    $('#user-role').val(user.role);
                    $('#userModalLabel').text('Edit User');
                    $('#userModal').modal('show');
                }
            });
            $('#user-form').on('submit', function(e) {
                e.preventDefault();
                const userId = $('#user-id').val();
                const userName = $('#user-name').val();
                const userRole = $('#user-role').val();

                if (userId) { // Editing existing user
                    state.users[userId] = { ...state.users[userId], name: userName, role: userRole };
                    showToast('User updated successfully!');
                } else { // Adding new user
                    const newId = `user_${Date.now()}`;
                    state.users[newId] = { id: newId, name: userName, role: userRole };
                    showToast('User added successfully!');
                }
                $('#userModal').modal('hide');
                render();
            });
            $('body').on('click', '.remove-user-btn', function() {
                const userId = $(this).data('user-id');
                const user = state.users[userId];
                Swal.fire({
                    title: 'Are you sure?',
                    text: `You are about to remove ${user.name}. This cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove them!',
                    cancelButtonText: 'No, keep them'
                }).then((result) => {
                    if (result.isConfirmed) {
                        delete state.users[userId];
                        Swal.fire('Removed!', `${user.name} has been removed.`, 'success');
                        render();
                    }
                });
            });

            // --- TABLE MANAGEMENT ---
            $('body').on('click', '#add-table-btn', function() {
                $('#table-form')[0].reset();
                $('#table-id').val('');
                $('#tableModalLabel').text('Add New Table');
                $('#table-status').prop('disabled', false);
                $('#tableModal').modal('show');
            });

            $('body').on('click', '.edit-table-btn', function() {
                const tableId = $(this).data('table-id');
                const table = state.tables.find(t => t.id === tableId);
                if (table) {
                    $('#table-id').val(table.id);
                    $('#table-name').val(table.name);
                    $('#table-status').val(table.status);
                    
                    if(table.status === 'occupied' || table.status === 'billing'){
                        $('#table-status').prop('disabled', true);
                    } else {
                        $('#table-status').prop('disabled', false);
                    }

                    $('#tableModalLabel').text(`Edit ${table.name}`);
                    $('#tableModal').modal('show');
                }
            });
            
             $('body').on('click', '.remove-table-btn', function() {
                const tableId = $(this).data('table-id');
                const table = state.tables.find(t => t.id === tableId);
                if (table) {
                    if(table.status !== 'available') {
                        Swal.fire('Cannot Remove', 'Only available tables can be removed.', 'error');
                        return;
                    }
                    Swal.fire({
                        title: 'Are you sure?',
                        text: `You are about to remove ${table.name}. This cannot be undone.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, remove it!',
                        cancelButtonText: 'No, keep it'
                    }).then((result) => {
                         if (result.isConfirmed) {
                             state.tables = state.tables.filter(t => t.id !== tableId);
                             Swal.fire('Removed!', `${table.name} has been removed.`, 'success');
                             render();
                         }
                    });
                }
            });

            $('#table-form').on('submit', function(e) {
                e.preventDefault();
                const tableId = parseInt($('#table-id').val());
                const tableName = $('#table-name').val();
                const tableStatus = $('#table-status').val();

                if (tableId) { // Editing
                    const table = state.tables.find(t => t.id === tableId);
                    if(table) {
                        table.name = tableName;
                        if(!$('#table-status').is(':disabled')){
                           table.status = tableStatus;
                        }
                    }
                    showToast('Table updated successfully!');
                } else { // Adding
                    const newId = state.tables.length > 0 ? Math.max(...state.tables.map(t => t.id)) + 1 : 1;
                    state.tables.push({
                        id: newId,
                        name: tableName,
                        status: tableStatus,
                        order: []
                    });
                     showToast('Table added successfully!');
                }
                $('#tableModal').modal('hide');
                render();
            });

            // --- SEARCH & REPORT HANDLERS ---
            $('body').on('input', '#menu-search-input', renderFilteredMenuList);
            
            $('body').on('input', '.inventory-search', function() {
                const category = $(this).data('category');
                updateInventoryTable(category);
            });
             $('body').on('input change', '#inventory-report-search, #inventory-report-category-filter, #inventory-report-status-filter', renderInventoryReport);


            $('body').on('click', '.report-range-btn', function() {
                state.report.range = '7days';
                renderReportsPage();
            });
            
            $('body').on('change', '#report-year-select, #report-month-select', function() {
                state.report.range = 'custom';
                state.report.year = parseInt($('#report-year-select').val());
                state.report.month = $('#report-month-select').val();
                $('.report-range-btn').removeClass('active');
                createSalesChart();
            });

            $('body').on('click', '.report-tab-btn', function() {
                state.report.activeReport = $(this).data('report');
                if (state.report.activeReport === 'sales') {
                    renderSalesReport();
                } else {
                    renderInventoryReport();
                }
            });


            // Save active inventory tab
            $('body').on('shown.bs.tab', '#inventoryTab button[data-bs-toggle="tab"]', function (e) {
                localStorage.setItem('activeInventoryTab', $(e.target).attr('data-bs-target'));
            });

            
            // Handle focus after modals close to prevent accessibility issues
            $('.modal').on('hidden.bs.modal', function () {
                if (document.activeElement) {
                    document.activeElement.blur();
                }
            });


            // --- INITIALIZATION ---
            initializeData();
            render();
        });
    </script>
</body>
</html>

