<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        :root {
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --emerald-400: #34d399;
            --emerald-500: #10b981;
            --blue-500: #3b82f6;
            --yellow-500: #eab308;
            --red-500: #ef4444;
            --purple-500: #8b5cf6;
            --gray-500: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--slate-900);
            color: var(--slate-300);
        }

        /* --- SweetAlert2 Dark Theme --- */
        .swal2-popup {
            background-color: var(--slate-800) !important;
            color: var(--slate-300) !important;
        }
        .swal2-title {
            color: white !important;
        }
        .swal2-confirm {
            background-color: var(--emerald-500) !important;
        }
        .swal2-cancel {
            background-color: var(--slate-600) !important;
        }
        .swal2-toast .swal2-title {
            color: white !important;
            margin: 0.5em 1em;
            font-size: 1em;
        }
        .swal2-toast .swal2-html-container {
             margin-left: 1em;
             margin-right: 1em;
        }


        /* --- Login Page --- */
        #login-page {
            min-height: 100vh;
        }
        .login-btn {
            background-color: var(--slate-800);
            border: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .login-btn:hover {
            background-color: var(--emerald-500);
            color: var(--slate-900) !important;
        }
        
        /* --- Header --- */
        .main-header {
            background-color: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
        }
        .nav-btn {
            color: var(--slate-300);
            background-color: transparent;
            border: none;
        }
        .nav-btn.active {
            background-color: var(--emerald-500);
            color: var(--slate-900);
        }
        .nav-btn:hover:not(.active) {
            background-color: var(--slate-700);
            color: white;
        }
        .mobile-nav .nav-btn {
            background-color: var(--slate-700);
            color: var(--slate-300);
        }
        .mobile-nav .nav-btn.active {
             background-color: var(--emerald-500);
            color: var(--slate-900);
        }

        /* --- Table Layout --- */
        .table-card-wrapper {
            position: relative;
        }
        .table-card {
            aspect-ratio: 1 / 1;
            transition: transform 0.2s;
        }
        .table-card:hover {
            transform: scale(1.05);
        }
        .table-card-admin-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }
         .table-card-admin-controls .btn {
            background-color: rgba(0,0,0,0.4);
            border: none;
        }
        .table-card.available { background-color: var(--slate-700); }
        .table-card.available:hover { background-color: var(--slate-600); }
        .table-card.occupied { background-color: var(--blue-500); }
        .table-card.occupied:hover { background-color: #2563eb; }
        .table-card.billing { background-color: var(--yellow-500); }
        .table-card.billing:hover { background-color: #ca8a04; }
        .table-card.reserved { background-color: var(--purple-500); }
        .table-card.reserved:hover { background-color: #7c3aed; }
        .table-card.unavailable { background-color: var(--gray-500); }
        .table-card.unavailable:hover { background-color: #4b5563; }

        /* --- Dashboard --- */
        .stat-card, .data-card {
            background-color: var(--slate-800);
        }
        .stat-card i { font-size: 2.5rem; }
        .list-group-item-dark {
            background-color: rgba(51, 65, 85, 0.5);
            border-color: var(--slate-700);
        }

        /* --- Kitchen Display --- */
        .kot-column {
            background-color: var(--slate-800);
        }
        .kot-card {
            background-color: var(--slate-700);
        }
        
        /* --- User/Reports Page --- */
        .user-card {
            background-color: var(--slate-800);
            border: 1px solid var(--slate-700);
        }

        /* --- Inventory --- */
        .table-dark {
            --bs-table-bg: var(--slate-800);
            --bs-table-border-color: var(--slate-700);
            --bs-table-header-bg: var(--slate-700);
        }
        .table-hover > tbody > tr:hover > * {
            --bs-table-hover-bg: rgba(51, 65, 85, 0.5);
        }

        /* --- Modals --- */
        .modal-content {
            background-color: var(--slate-800);
            color: var(--slate-300);
            border: 1px solid var(--slate-700);
        }
        .modal-header, .modal-footer {
            border-bottom-color: var(--slate-700);
            border-top-color: var(--slate-700);
        }
        .form-control-dark {
            background-color: var(--slate-700);
            color: white;
            border-color: var(--slate-600);
        }
        .form-control-dark:focus {
            background-color: var(--slate-700);
            color: white;
            border-color: var(--emerald-500);
            box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.25);
        }
        .menu-item-btn {
            background-color: var(--slate-700);
            border: none;
            color: white;
        }
        .menu-item-btn:hover {
            background-color: var(--emerald-500);
            color: var(--slate-900);
        }
        .order-summary, .bill-summary {
             background-color: rgba(15, 23, 42, 0.5);
        }
        .order-item {
            background-color: var(--slate-700);
        }
        .quantity-btn {
            background-color: var(--slate-600);
            color: white;
            width: 28px;
            height: 28px;
            border: none;
        }
        .quantity-btn:disabled {
            background-color: var(--slate-700);
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* --- Toast Notifications --- */
        .toast-container {
            z-index: 1100; /* Higher than modals */
        }

        /* --- Utility & Animations --- */
        .icon-lg { font-size: 4rem; }
        .text-emerald { color: var(--emerald-400); }
        .text-slate-400 { color: var(--slate-400); }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="login-page" class="d-flex flex-column justify-content-center align-items-center p-4">
        <div class="text-center mb-5">
            <i class="bi bi-egg-fried icon-lg text-emerald mb-4"></i>
            <h1 class="display-5 fw-bold text-white">Restaurant POS</h1>
            <p class="text-slate-400 mt-2">Select a user role to start the demo.</p>
        </div>
        <div id="login-form" class="w-100" style="max-width: 380px;">
            <!-- Login buttons will be injected here by JS -->
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="d-none">
        <!-- Header -->
        <header id="main-header" class="main-header shadow-lg sticky-top"></header>
        
        <!-- Main Content -->
        <main id="main-content" class="container-fluid p-3 p-sm-4 p-lg-5 fade-in"></main>
    </div>

    <!-- Modals -->
    <!-- Order Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title fs-4 fw-bold text-white" id="orderModalLabel"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 75vh;">
                    <div class="row g-4">
                        <div class="col-lg-7">
                            <div id="menu-container" class="overflow-auto pe-2" style="max-height: 65vh;"></div>
                        </div>
                        <div class="col-lg-5">
                            <div class="order-summary p-3 rounded-3 d-flex flex-column h-100">
                                <h3 class="fs-5 fw-bold text-white mb-3">Current Order</h3>
                                <div id="current-order-items" class="flex-grow-1 overflow-auto pe-2" style="min-height: 200px;">
                                    <p class="text-slate-400 text-center pt-5">No items added yet.</p>
                                </div>
                                <div id="order-modal-footer" class="mt-auto border-top border-secondary pt-3">
                                    <div class="d-flex justify-content-between align-items-center fs-3 fw-bold text-white mb-3">
                                        <span>Total:</span>
                                        <span id="order-total">$0.00</span>
                                    </div>
                                    <button id="place-order-btn" class="btn btn-lg w-100 fw-bold" style="background-color: var(--emerald-500); color: var(--slate-900);" disabled>Place Order</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Modal -->
    <div class="modal fade" id="billingModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content rounded-4">
            <div class="modal-header">
                <h5 class="modal-title fs-4 fw-bold text-white" id="billingModalLabel"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="bill-summary p-3 rounded-3 mb-3">
                    <h3 class="fs-6 fw-bold text-white mb-2">Order Summary</h3>
                    <div id="billing-items-summary"></div>
                </div>
                <div class="bill-summary p-3 rounded-3">
                    <div id="billing-totals-summary"></div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                 <div id="payment-buttons" class="d-grid gap-3 w-100"></div>
            </div>
        </div>
      </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="user-form">
                    <div class="modal-header">
                        <h5 class="modal-title fs-4 fw-bold text-white" id="userModalLabel">Add New User</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="user-id">
                        <div class="mb-3">
                            <label for="user-name" class="form-label">Full Name</label>
                            <input type="text" class="form-control form-control-dark" id="user-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="user-role" class="form-label">Role</label>
                            <select class="form-select form-control-dark" id="user-role" required>
                                <option value="Waiter">Waiter</option>
                                <option value="Kitchen">Kitchen</option>
                                <option value="Cashier">Cashier</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Inventory Management Modal -->
    <div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="inventory-form">
                    <div class="modal-header">
                        <h5 class="modal-title fs-4 fw-bold text-white" id="inventoryModalLabel">Add New Inventory Item</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="item-name" class="form-label">Item Name</label>
                            <input type="text" class="form-control form-control-dark" id="item-name" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="item-category" class="form-label">Category</label>
                                <select class="form-select form-control-dark" id="item-category" required>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="item-price" class="form-label">Price</label>
                                <input type="number" class="form-control form-control-dark" id="item-price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-6 mb-3">
                                <label for="item-stock" class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control form-control-dark" id="item-stock" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="item-low-stock" class="form-label">Low Stock Threshold</label>
                                <input type="number" class="form-control form-control-dark" id="item-low-stock" min="0" required>
                            </div>
                        </div>
                         <div class="mb-3">
                            <label for="item-supplier" class="form-label">Supplier</label>
                            <input type="text" class="form-control form-control-dark" id="item-supplier" value="Gourmet Foods Inc.">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Table Management Modal -->
    <div class="modal fade" id="tableModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="table-form">
                    <div class="modal-header">
                        <h5 class="modal-title fs-4 fw-bold text-white" id="tableModalLabel">Add New Table</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="table-id">
                        <div class="mb-3">
                            <label for="table-name" class="form-label">Table Name</label>
                            <input type="text" class="form-control form-control-dark" id="table-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="table-status" class="form-label">Status</label>
                            <select class="form-select form-control-dark" id="table-status" required>
                                <option value="available">Available</option>
                                <option value="reserved">Reserved</option>
                                <option value="unavailable">Unavailable</option>
                                <!-- Occupied and Billing are set via orders, not manually -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Table</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>


    <!-- JQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <script>
        $(document).ready(function() {
            // --- AUDIO CONTEXT for Web Audio API ---
            let audioCtx;
            // A gesture from the user is required to start the audio context.
            // We'll initialize it on the first login click.
            function initAudio() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
            }
            
            // --- CHART.JS DEFAULTS FOR DARK THEME ---
            Chart.defaults.color = 'rgba(148, 163, 184, 0.7)'; // slate-400
            Chart.defaults.borderColor = 'rgba(51, 65, 85, 0.5)'; // slate-700 with opacity

            // --- STATE MANAGEMENT (Global Variables) ---
            let state = {
                currentUser: null,
                currentPage: 'Tables',
                tables: [],
                orders: [], // Completed orders for reporting
                kitchenOrders: [], // Live kitchen orders
                inventory: [],
                menu: {},
                users: {},
                activeModalTableId: null,
                activeOrder: [], // Temporary state for the order modal
                salesChart: null,
            };

            // --- MOCK DATA INITIALIZATION ---
            function initializeData() {
                state.menu = {
                  Appetizers: [
                    { id: 1, name: "Spring Rolls", price: 8.50, stock: 50 },
                    { id: 2, name: "Garlic Bread", price: 6.00, stock: 100 },
                    { id: 3, name: "Bruschetta", price: 9.00, stock: 40 },
                  ],
                  'Main Course': [
                    { id: 4, name: "Spaghetti Carbonara", price: 18.00, stock: 30 },
                    { id: 5, name: "Grilled Salmon", price: 24.50, stock: 25 },
                    { id: 6, name: "Margherita Pizza", price: 15.00, stock: 40 },
                    { id: 7, name: "Chicken Alfredo", price: 19.50, stock: 35 },
                  ],
                  Desserts: [
                    { id: 8, name: "Tiramisu", price: 9.50, stock: 20 },
                    { id: 9, name: "Cheesecake", price: 8.00, stock: 25 },
                    { id: 10, name: "Chocolate Lava Cake", price: 10.00, stock: 15 },
                  ],
                  Drinks: [
                    { id: 11, name: "Cola", price: 3.50, stock: 200 },
                    { id: 12, name: "Orange Juice", price: 4.00, stock: 150 },
                    { id: 13, name: "Espresso", price: 3.00, stock: 300 },
                  ],
                };

                state.tables = Array.from({ length: 12 }, (_, i) => ({
                  id: i + 1,
                  name: `Table ${i + 1}`,
                  status: 'available',
                  order: [],
                }));

                state.inventory = Object.values(state.menu).flat().map(item => ({
                    ...item,
                    supplier: 'Gourmet Foods Inc.',
                    lowStockThreshold: 10,
                }));
                
                state.users = {
                  'admin': { id: 'admin', name: 'Alex Green', role: 'Admin' },
                  'manager': { id: 'manager', name: 'Brenda Smith', role: 'Manager' },
                  'waiter': { id: 'waiter', name: 'Charles Davis', role: 'Waiter' },
                  'kitchen': { id: 'kitchen', name: 'Diana Prince', role: 'Kitchen' },
                  'cashier': { id: 'cashier', name: 'Edward Frank', role: 'Cashier' },
                };
            }

            // --- HELPER FUNCTIONS ---
            function playSound(type) {
                if (!audioCtx) {
                    console.warn("AudioContext not initialized. User interaction needed.");
                    return;
                }

                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
                
                oscillator.type = 'sine';

                switch (type) {
                    case 'new-order':
                        oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
                        break;
                    case 'order-ready':
                        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                        setTimeout(() => { oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.15); }, 150);
                        break;
                    case 'billing-ready':
                         oscillator.frequency.setValueAtTime(698.46, audioCtx.currentTime); // F5
                        break;
                }
                
                oscillator.start(audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
                oscillator.stop(audioCtx.currentTime + 0.5);
            }
            
            function showToast(message, type = 'success') {
                const toastId = `toast-${Date.now()}`;
                const toastBg = type === 'success' ? 'bg-success' : 'bg-danger';
                const toastHtml = `
                    <div id="${toastId}" class="toast align-items-center text-white ${toastBg} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                $('.toast-container').append(toastHtml);
                const toastElement = new bootstrap.Toast($(`#${toastId}`));
                toastElement.show();
                $(`#${toastId}`).on('hidden.bs.toast', function () {
                    $(this).remove();
                });
            }
            
            function calculateOrderDifference(oldOrder, newOrder) {
                const diff = [];
                const oldOrderMap = new Map(oldOrder.map(item => [item.id, item.quantity]));

                for (const newItem of newOrder) {
                    const oldQuantity = oldOrderMap.get(newItem.id) || 0;
                    const quantityDiff = newItem.quantity - oldQuantity;

                    if (quantityDiff > 0) {
                        diff.push({ ...newItem, quantity: quantityDiff });
                    }
                }
                return diff;
            }

            // --- RENDER FUNCTIONS ---
            
            // Main render function
            function render() {
                if (state.currentUser) {
                    $('#login-page').addClass('d-none');
                    $('#app').removeClass('d-none');
                    renderHeader();
                    renderPage();
                } else {
                    $('#login-page').removeClass('d-none');
                    $('#app').addClass('d-none');
                    renderLoginPage();
                }
            }

            function renderLoginPage() {
                const loginForm = $('#login-form');
                loginForm.empty();
                $.each(state.users, (key, user) => {
                    loginForm.append(`
                        <button class="btn btn-lg login-btn text-white w-100 p-3 mb-3 d-flex justify-content-between align-items-center" data-role-id="${user.id}">
                            <span class="fw-semibold">Login as <span class="fw-bold">${user.role}</span></span>
                            <i class="bi bi-box-arrow-in-right fs-5"></i>
                        </button>
                    `);
                });
            }

            function renderHeader() {
                const navLinks = {
                    Admin: ['Dashboard', 'Tables', 'Kitchen', 'Inventory', 'Reports', 'Users'],
                    Manager: ['Dashboard', 'Tables', 'Kitchen', 'Inventory', 'Reports'],
                    Waiter: ['Tables'],
                    Kitchen: ['Kitchen'],
                    Cashier: ['Dashboard', 'Tables'],
                };
                const icons = {
                    Dashboard: 'bi-bar-chart-line-fill',
                    Tables: 'bi-grid-1x2-fill',
                    Kitchen: 'bi-egg-fried',
                    Inventory: 'bi-cart-fill',
                    Reports: 'bi-file-earmark-bar-graph-fill',
                    Users: 'bi-people-fill',
                };
                
                const links = navLinks[state.currentUser.role];
                const desktopNavHtml = links.map(page => `
                    <button class="btn nav-btn rounded-pill px-3 py-2 me-2 nav-link ${state.currentPage === page ? 'active' : ''}" data-page="${page}">
                        <i class="bi ${icons[page]} me-2"></i>${page}
                    </button>
                `).join('');

                const mobileNavHtml = links.map(page => `
                    <button class="btn nav-btn rounded-pill px-3 py-2 flex-shrink-0 nav-link ${state.currentPage === page ? 'active' : ''}" data-page="${page}">
                        <i class="bi ${icons[page]} me-2"></i>${page}
                    </button>
                `).join('');

                $('#main-header').html(`
                    <nav class="navbar navbar-expand-md">
                        <div class="container-fluid">
                            <a class="navbar-brand text-white fw-bold fs-4 d-flex align-items-center" href="#">
                                <i class="bi bi-egg-fried text-emerald me-2 fs-3"></i>
                                <span class="d-none d-sm-inline">POS System</span>
                            </a>
                            <div class="d-none d-md-flex">
                                ${desktopNavHtml}
                            </div>
                            <div class="d-flex align-items-center ms-auto">
                                <div class="text-end me-3">
                                    <div class="text-white fw-medium">${state.currentUser.name}</div>
                                    <small class="text-slate-400">${state.currentUser.role}</small>
                                </div>
                                <button id="logout-btn" class="btn btn-danger">Logout</button>
                            </div>
                        </div>
                    </nav>
                    <div class="d-md-none mobile-nav d-flex overflow-auto p-2 gap-2">
                        ${mobileNavHtml}
                    </div>
                `);
            }
            
            function renderPage() {
                $('#main-content').html(''); // Clear previous content
                if (state.salesChart) {
                    state.salesChart.destroy();
                    state.salesChart = null;
                }

                switch (state.currentPage) {
                    case 'Dashboard': renderDashboardPage(); break;
                    case 'Tables': renderTableLayoutPage(); break;
                    case 'Kitchen': renderKitchenPage(); break;
                    case 'Inventory': renderInventoryPage(); break;
                    case 'Reports': renderReportsPage(); break;
                    case 'Users': renderUserManagementPage(); break;
                    default: renderTableLayoutPage(); break;
                }
            }

            function renderTableLayoutPage() {
                const isAdmin = state.currentUser.role === 'Admin';
                
                let adminHeader = '';
                if(isAdmin) {
                    adminHeader = `
                        <div class="d-flex justify-content-between align-items-center mb-4">
                             <h1 class="text-3xl fw-bold text-white mb-0">Table Layout</h1>
                             <button class="btn btn-success d-flex align-items-center" id="add-table-btn">
                                <i class="bi bi-plus-circle me-2"></i> Add Table
                             </button>
                        </div>
                    `;
                } else {
                     adminHeader = `<h1 class="text-3xl fw-bold text-white mb-4">Table Layout</h1>`;
                }

                const tableCards = state.tables.map(table => {
                    let adminControls = '';
                    if(isAdmin) {
                        adminControls = `
                            <div class="table-card-admin-controls">
                                <button class="btn btn-sm text-white edit-table-btn" data-table-id="${table.id}"><i class="bi bi-pencil-fill"></i></button>
                                <button class="btn btn-sm text-white remove-table-btn" data-table-id="${table.id}"><i class="bi bi-trash-fill"></i></button>
                            </div>
                        `;
                    }
                    return `
                        <div class="col">
                            <div class="table-card-wrapper">
                                ${adminControls}
                                <button class="btn table-card w-100 rounded-4 shadow d-flex flex-column justify-content-center align-items-center fw-bold fs-4 text-white ${table.status}" data-table-id="${table.id}" ${table.status === 'unavailable' ? 'disabled' : ''}>
                                    <span>${table.name}</span>
                                    <span class="fs-6 fw-normal text-capitalize">${table.status}</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                const content = `
                    ${adminHeader}
                    <div id="table-grid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-4">
                       ${tableCards}
                    </div>
                `;
                $('#main-content').html(content);
            }
            
            function renderDashboardPage() {
                const completedOrders = state.orders.filter(o => o.status === 'completed');
                const totalSales = completedOrders.reduce((sum, order) => sum + order.total, 0);
                const activeKOTs = state.kitchenOrders.filter(o => o.status !== 'served');
                const lowStockItems = state.inventory.filter(i => i.stock <= i.lowStockThreshold).length;

                // Top Selling Items
                const itemCounts = completedOrders
                    .flatMap(o => o.items)
                    .reduce((acc, item) => {
                        acc[item.name] = (acc[item.name] || 0) + item.quantity;
                        return acc;
                    }, {});

                const topSellingItems = Object.entries(itemCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5)
                    .map(([name, quantity]) => `
                        <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                            ${name} <span class="badge bg-success rounded-pill">${quantity} sold</span>
                        </li>
                    `).join('');
                
                // Recent Orders
                const recentOrders = state.orders.slice(-5).reverse().map(order => `
                    <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${order.tableName}</div>
                            <small class="text-slate-400">${order.items.length} items</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold fs-5">$${order.total.toFixed(2)}</div>
                            <span class="badge bg-success-subtle text-success-emphasis rounded-pill">${order.status}</span>
                        </div>
                    </li>
                `).join('');

                const content = `
                    <h1 class="text-3xl fw-bold text-white mb-4">Dashboard</h1>
                    <div class="row g-4 mb-4">
                        <!-- Stat Cards -->
                        <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Total Sales</p>
                                    <p class="fs-2 fw-bold text-white mb-0">$${totalSales.toFixed(2)}</p>
                                </div>
                                <i class="bi bi-cash-coin text-emerald"></i>
                            </div>
                        </div>
                         <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Active Orders</p>
                                    <p class="fs-2 fw-bold text-white mb-0">${activeKOTs.length}</p>
                                </div>
                                <i class="bi bi-clock-history" style="color: var(--blue-500);"></i>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Completed Orders</p>
                                    <p class="fs-2 fw-bold text-white mb-0">${completedOrders.length}</p>
                                </div>
                                <i class="bi bi-check-circle-fill" style="color: #16a34a;"></i>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3">
                            <div class="stat-card p-4 rounded-4 shadow d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-slate-400 mb-1">Low Stock Items</p>
                                    <p class="fs-2 fw-bold text-white mb-0">${lowStockItems}</p>
                                </div>
                                <i class="bi bi-exclamation-triangle-fill" style="color: var(--red-500);"></i>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <!-- Data Sections -->
                        <div class="col-lg-6">
                            <div class="data-card p-4 rounded-4 shadow">
                                <h2 class="fs-5 fw-bold text-white mb-3">Top Selling Items</h2>
                                <ul class="list-group">${topSellingItems || '<li class="list-group-item list-group-item-dark">No sales data yet.</li>'}</ul>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="data-card p-4 rounded-4 shadow">
                                <h2 class="fs-5 fw-bold text-white mb-3">Recent Orders</h2>
                                <ul class="list-group">${recentOrders || '<li class="list-group-item list-group-item-dark">No completed orders yet.</li>'}</ul>
                            </div>
                        </div>
                    </div>
                `;
                $('#main-content').html(content);
            }

            function renderKitchenPage() {
                const columns = {
                    New: state.kitchenOrders.filter(o => o.status === 'new'),
                    Preparing: state.kitchenOrders.filter(o => o.status === 'preparing'),
                    Ready: state.kitchenOrders.filter(o => o.status === 'ready'),
                };

                let columnsHtml = '';
                for (const [status, orders] of Object.entries(columns)) {
                    columnsHtml += `
                        <div class="col-md-4">
                            <div class="kot-column rounded-4 d-flex flex-column h-100">
                                <h2 class="fs-5 fw-bold text-white p-3 border-bottom border-secondary">${status} (${orders.length})</h2>
                                <div class="p-3 space-y-4 overflow-auto">
                                    ${orders.map(order => {
                                        let actionButton = '';
                                        if (status === 'New') actionButton = `<button class="btn btn-sm btn-primary kot-action-btn" data-order-id="${order.id}" data-action="preparing">Start</button>`;
                                        if (status === 'Preparing') actionButton = `<button class="btn btn-sm btn-success kot-action-btn" data-order-id="${order.id}" data-action="ready">Ready</button>`;
                                        if (status === 'Ready') actionButton = `<button class="btn btn-sm btn-secondary kot-action-btn" data-order-id="${order.id}" data-action="served">Serve</button>`;

                                        return `
                                            <div class="kot-card p-3 rounded-3 shadow-sm mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h3 class="fw-bold text-white fs-6 mb-0">${order.tableName}</h3>
                                                    <small class="text-slate-400">${new Date(order.timestamp).toLocaleTimeString()}</small>
                                                </div>
                                                <ul class="list-unstyled mb-3">
                                                    ${order.items.map(item => `
                                                        <li><span class="fw-semibold text-emerald">${item.quantity}x</span> ${item.name}</li>
                                                    `).join('')}
                                                </ul>
                                                <div class="d-flex justify-content-end gap-2">
                                                    ${status === 'Preparing' ? `<button class="btn btn-sm btn-outline-warning kot-action-btn" data-order-id="${order.id}" data-action="move-to-new">Back</button>` : ''}
                                                    ${status === 'Ready' ? `<button class="btn btn-sm btn-outline-warning kot-action-btn" data-order-id="${order.id}" data-action="move-to-preparing">Back</button>` : ''}
                                                    ${actionButton}
                                                </div>
                                            </div>
                                        `
                                    }).join('') || `<p class="text-slate-400 text-center p-5">No orders</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                }

                const content = `
                    <h1 class="text-3xl fw-bold text-white mb-4">Kitchen Orders (KOT)</h1>
                    <div class="row" style="min-height: 75vh;">${columnsHtml}</div>
                `;
                 $('#main-content').html(content);
            }
            
            function renderInventoryPage() {
                const getCategory = (itemId) => Object.entries(state.menu).find(([, items]) => items.some(i => i.id === itemId))?.[0] || 'N/A';
                
                const tableRows = state.inventory.map(item => `
                    <tr class="align-middle">
                        <td class="p-3 fw-medium text-white">${item.name}</td>
                        <td class="p-3">${getCategory(item.id)}</td>
                        <td class="p-3 text-end">$${item.price.toFixed(2)}</td>
                        <td class="p-3 text-end font-monospace">${item.stock}</td>
                        <td class="p-3">
                             ${item.stock > item.lowStockThreshold 
                                ? `<span class="badge bg-success-subtle text-success-emphasis rounded-pill">In Stock</span>`
                                : `<span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Low Stock</span>`
                             }
                        </td>
                        <td class="p-3 text-center">
                            <button class="btn btn-sm btn-outline-success restock-btn" data-item-id="${item.id}">Restock</button>
                        </td>
                    </tr>
                `).join('');

                const content = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="text-3xl fw-bold text-white mb-0">Inventory Management</h1>
                        <button class="btn btn-success d-flex align-items-center" id="add-inventory-item-btn">
                            <i class="bi bi-plus-circle me-2"></i> Add New Item
                        </button>
                    </div>
                    <div class="data-card rounded-4 shadow overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead class="text-uppercase small">
                                    <tr>
                                        <th class="p-3">Item Name</th>
                                        <th class="p-3">Category</th>
                                        <th class="p-3 text-end">Unit Price</th>
                                        <th class="p-3 text-end">Stock Quantity</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                 $('#main-content').html(content);
            }

            function renderUserManagementPage() {
                const userCardsHtml = Object.values(state.users).map(user => `
                    <div class="col-md-6 col-lg-4">
                        <div class="user-card p-3 rounded-4 d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="fs-6 fw-bold text-white mb-0">${user.name}</h3>
                                <p class="text-slate-400 mb-0">${user.role}</p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2 edit-user-btn" data-user-id="${user.id}">Edit</button>
                                <button class="btn btn-sm btn-outline-danger remove-user-btn" data-user-id="${user.id}">Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                const content = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="text-3xl fw-bold text-white mb-0">User Management</h1>
                        <button class="btn btn-success d-flex align-items-center" id="add-user-btn">
                            <i class="bi bi-plus-circle me-2"></i> Add New User
                        </button>
                    </div>
                    <div class="row g-3">
                        ${userCardsHtml}
                    </div>
                `;
                $('#main-content').html(content);
            }

            function renderReportsPage() {
                 const content = `
                    <h1 class="text-3xl fw-bold text-white mb-4">Sales Report</h1>
                     <div class="row g-4">
                        <div class="col-12">
                            <div class="data-card p-4 rounded-4 shadow">
                                <h2 class="fs-5 fw-bold text-white mb-3">Sales Over Time (Last 7 Days)</h2>
                                <div style="position: relative; height:60vh">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $('#main-content').html(content);
                
                // Initialize Chart
                const ctx = document.getElementById('salesChart').getContext('2d');
                const labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Today'];
                const data = {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales ($)',
                        data: [650, 590, 800, 810, 560, 550, state.orders.reduce((sum, o) => sum + o.total, 0)],
                        fill: false,
                        borderColor: 'rgb(16, 185, 129)',
                        tension: 0.1
                    }]
                };
                state.salesChart = new Chart(ctx, { 
                    type: 'line', 
                    data: data, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // --- MODAL RENDER FUNCTIONS ---
            
            function openOrderModal(tableId) {
                state.activeModalTableId = tableId;
                const table = state.tables.find(t => t.id === tableId);
                $('#orderModalLabel').text(`Order for ${table.name}`);
                
                state.activeOrder = JSON.parse(JSON.stringify(table.order));
                
                const isOrderLocked = state.kitchenOrders.some(ko => ko.tableId === table.id && (ko.status === 'preparing' || ko.status === 'ready'));

                // Render Menu
                const menuContainer = $('#menu-container');
                menuContainer.empty();
                $.each(state.menu, (category, items) => {
                    const itemsHtml = items.map(item => `
                        <div class="col">
                            <button class="btn menu-item-btn w-100 text-start p-3 rounded-3" data-item-id="${item.id}" ${item.stock <= 0 ? 'disabled' : ''}>
                                <div class="fw-semibold">${item.name} ${item.stock <= 0 ? '<span class="text-danger small">(Out of Stock)</span>' : ''}</div>
                                <div class="small text-slate-300">$${item.price.toFixed(2)}</div>
                            </button>
                        </div>
                    `).join('');
                    menuContainer.append(`
                        <h4 class="text-emerald fw-bold fs-6 mb-2">${category}</h4>
                        <div class="row row-cols-1 row-cols-sm-2 g-2 mb-3">${itemsHtml}</div>
                    `);
                });

                updateOrderSummary(state.activeOrder, isOrderLocked);
                $('#orderModal').modal('show');
            }

            function updateOrderSummary(currentOrder, isOrderLocked = false) {
                const orderItemsContainer = $('#current-order-items');
                const table = state.tables.find(t => t.id === state.activeModalTableId);
                const originalOrderMap = new Map(table.order.map(i => [i.id, i.quantity]));

                if (!currentOrder || currentOrder.length === 0) {
                    orderItemsContainer.html('<p class="text-slate-400 text-center pt-5">No items added yet.</p>');
                } else {
                    orderItemsContainer.empty();
                    currentOrder.forEach(item => {
                        const originalQuantity = originalOrderMap.get(item.id) || 0;
                        const isItemLocked = isOrderLocked && originalQuantity > 0;
                        const canDecrease = !isItemLocked || (isItemLocked && item.quantity > originalQuantity);

                        orderItemsContainer.append(`
                            <div class="order-item d-flex justify-content-between align-items-center p-2 rounded-3 mb-2">
                                <div>
                                    <div class="fw-semibold text-white">${item.name}</div>
                                    <div class="small text-slate-300">$${item.price.toFixed(2)}</div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm rounded-circle quantity-btn" data-item-id="${item.id}" data-change="-1" ${!canDecrease ? 'disabled' : ''}>-</button>
                                    <span class="fw-bold text-white" style="min-width: 20px; text-align: center;">${item.quantity}</span>
                                    <button class="btn btn-sm rounded-circle quantity-btn" data-item-id="${item.id}" data-change="1">+</button>
                                </div>
                            </div>
                        `);
                    });
                }
                
                const total = currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0);
                $('#order-total').text(`$${total.toFixed(2)}`);
                
                const mainButton = $('#place-order-btn');
                mainButton.prop('disabled', currentOrder.length === 0);
                mainButton.text(table.order.length > 0 ? 'Update Order' : 'Place Order');

                const footer = $('#order-modal-footer');
                footer.find('#cancel-order-btn').remove();
                const isCancellable = table.order.length > 0 && !isOrderLocked;

                if (isCancellable) {
                    footer.append('<button id="cancel-order-btn" class="btn btn-danger w-100 fw-bold mt-2">Cancel Entire Order</button>');
                }
            }

            function openBillingModal(tableId) {
                state.activeModalTableId = tableId;
                const table = state.tables.find(t => t.id === tableId);
                const subtotal = table.order.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const tax = subtotal * 0.08;
                const serviceCharge = subtotal * 0.10;
                const total = subtotal + tax + serviceCharge;

                $('#billingModalLabel').text(`Bill for ${table.name}`);
                
                $('#billing-items-summary').html(
                    table.order.map(item => `
                        <div class="d-flex justify-content-between py-1 text-slate-300">
                            <span>${item.name} x ${item.quantity}</span>
                            <span>$${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')
                );

                $('#billing-totals-summary').html(`
                    <div class="d-flex justify-content-between text-slate-300"><span>Subtotal:</span> <span>$${subtotal.toFixed(2)}</span></div>
                    <div class="d-flex justify-content-between text-slate-300"><span>Tax (8%):</span> <span>$${tax.toFixed(2)}</span></div>
                    <div class="d-flex justify-content-between text-slate-300"><span>Service Charge (10%):</span> <span>$${serviceCharge.toFixed(2)}</span></div>
                    <hr class="border-secondary">
                    <div class="d-flex justify-content-between text-white fs-4 fw-bold"><span>Total:</span> <span>$${total.toFixed(2)}</span></div>
                `);

                $('#payment-buttons').html(`
                    <button class="btn btn-lg btn-success payment-btn" data-total="${total}">Pay with Card</button>
                    <button class="btn btn-lg btn-primary payment-btn" data-total="${total}">Pay with Cash</button>
                `);

                $('#billingModal').modal('show');
            }


            // --- EVENT HANDLERS ---
            
            // Login
            $('#login-form').on('click', '.login-btn', function() {
                initAudio(); // Initialize AudioContext on first user interaction
                const roleId = $(this).data('role-id');
                state.currentUser = Object.values(state.users).find(u => u.id === roleId);
                
                switch (state.currentUser.role) {
                    case 'Admin':
                    case 'Manager':
                    case 'Cashier':
                        state.currentPage = 'Dashboard';
                        break;
                    case 'Kitchen':
                        state.currentPage = 'Kitchen';
                        break;
                    default:
                        state.currentPage = 'Tables';
                }
                render();
            });

            // Logout
            $('body').on('click', '#logout-btn', function() {
                state.currentUser = null;
                render();
            });
            
            // Navigation
            $('body').on('click', '.nav-link', function() {
                state.currentPage = $(this).data('page');
                render();
            });

            // Table Selection
            $('body').on('click', '.table-card', function() {
                const tableId = $(this).data('table-id');
                const table = state.tables.find(t => t.id === tableId);
                const userRole = state.currentUser.role;

                if (table.status === 'billing') {
                    if (userRole === 'Cashier' || userRole === 'Admin' || userRole === 'Manager') {
                        openBillingModal(tableId);
                    } else {
                        Swal.fire({
                            title: 'Billing in Progress',
                            text: `The bill for ${table.name} is ready. The cashier will process the payment.`,
                            icon: 'info'
                        });
                    }
                } else if (table.status === 'available' || table.status === 'occupied') {
                    if (userRole === 'Waiter' || userRole === 'Admin' || userRole === 'Manager') {
                         openOrderModal(tableId);
                    } else {
                         Swal.fire({
                            title: 'Action Not Allowed',
                            text: 'Only Waiters, Managers, or Admins can place or modify orders.',
                            icon: 'warning'
                        });
                    }
                } else {
                     Swal.fire({
                        title: `Table Status: ${table.status}`,
                        text: `${table.name} is currently ${table.status}.`,
                        icon: 'info'
                    });
                }
            });

            // Order Modal: Add Item
            $('#orderModal').on('click', '.menu-item-btn', function() {
                const itemId = $(this).data('item-id');
                const itemData = Object.values(state.menu).flat().find(i => i.id === itemId);

                const existingItem = state.activeOrder.find(orderItem => orderItem.id === itemId);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    state.activeOrder.push({ ...itemData, quantity: 1 });
                }
                const isOrderLocked = state.kitchenOrders.some(ko => ko.tableId === state.activeModalTableId && (ko.status === 'preparing' || ko.status === 'ready'));
                updateOrderSummary(state.activeOrder, isOrderLocked);
            });
            
            // Order Modal: Update Quantity
            $('#orderModal').on('click', '.quantity-btn', function() {
                const itemId = $(this).data('item-id');
                const change = $(this).data('change');
                const itemInOrder = state.activeOrder.find(orderItem => orderItem.id === itemId);
                const isOrderLocked = state.kitchenOrders.some(ko => ko.tableId === state.activeModalTableId && (ko.status === 'preparing' || ko.status === 'ready'));

                if (itemInOrder) {
                    const table = state.tables.find(t => t.id === state.activeModalTableId);
                    const originalItem = table.order.find(i => i.id === itemId);
                    const originalQuantity = originalItem ? originalItem.quantity : 0;

                    if (change < 0 && isOrderLocked && itemInOrder.quantity <= originalQuantity) {
                        showToast("Cannot reduce quantity of an item being prepared.", "danger");
                        return;
                    }

                    itemInOrder.quantity += change;
                    if (itemInOrder.quantity <= 0) {
                        state.activeOrder = state.activeOrder.filter(i => i.id !== itemId);
                    }
                }
                updateOrderSummary(state.activeOrder, isOrderLocked);
            });

            // Order Modal: Place or Update Order
            $('#place-order-btn').on('click', function() {
                const tableId = state.activeModalTableId;
                const table = state.tables.find(t => t.id === tableId);
                const newCompleteOrder = state.activeOrder;

                if (!table) return;

                const existingNewKot = state.kitchenOrders.find(ko => ko.tableId === tableId && ko.status === 'new');

                if (existingNewKot) {
                    existingNewKot.items = [...newCompleteOrder];
                    showToast(`Order for ${table.name} has been updated.`);
                    playSound('new-order');
                } else {
                    const itemsForNewKot = calculateOrderDifference(table.order, newCompleteOrder);
                    
                    if (itemsForNewKot.length > 0) {
                        state.kitchenOrders.unshift({
                            id: Date.now(),
                            tableId: table.id,
                            tableName: table.name,
                            items: itemsForNewKot,
                            status: 'new',
                            timestamp: new Date().toISOString(),
                        });
                        showToast(`New items for ${table.name} sent to kitchen.`);
                        playSound('new-order');
                    } else {
                        showToast(`No new items to send for ${table.name}.`);
                    }
                }
                
                table.order = [...newCompleteOrder];
                table.status = table.order.length > 0 ? 'occupied' : 'available';
                $('#orderModal').modal('hide');
                render();
            });
            
            // Order Modal: Cancel Order
            $('body').on('click', '#cancel-order-btn', function() {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This will cancel the entire order for this table.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, cancel it!',
                    cancelButtonText: 'No, keep it'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const tableId = state.activeModalTableId;
                        const table = state.tables.find(t => t.id === tableId);
                        
                        // Remove the corresponding 'new' KOT from the kitchen list
                        state.kitchenOrders = state.kitchenOrders.filter(ko => !(ko.tableId === tableId && ko.status === 'new'));
                        
                        table.order = [];
                        table.status = 'available';

                        $('#orderModal').modal('hide');
                        Swal.fire('Cancelled!', `Order for ${table.name} has been cancelled.`, 'success');
                        render();
                    }
                });
            });


            // Billing Modal: Process Payment
            $('#billingModal').on('click', '.payment-btn', function() {
                const total = $(this).data('total');
                const table = state.tables.find(t => t.id === state.activeModalTableId);
                
                // Update Inventory
                table.order.forEach(orderItem => {
                    const inventoryItem = state.inventory.find(inv => inv.id === orderItem.id);
                    if (inventoryItem) {
                        inventoryItem.stock -= orderItem.quantity;
                    }
                });
                
                // Create completed order record
                state.orders.push({
                    id: Date.now(),
                    tableId: table.id,
                    tableName: table.name,
                    items: table.order,
                    total: parseFloat(total),
                    status: 'completed',
                    timestamp: new Date().toISOString(),
                });
                
                // Reset table
                table.status = 'available';
                table.order = [];

                $('#billingModal').modal('hide');
                showToast('Payment successful! Table is now available.');
                render();
            });

            // Kitchen: Update Order Status
            $('body').on('click', '.kot-action-btn', function() {
                const orderId = $(this).data('order-id');
                const action = $(this).data('action');
                const order = state.kitchenOrders.find(o => o.id === orderId);

                if (!order) return;

                switch (action) {
                    case 'served':
                        state.kitchenOrders = state.kitchenOrders.filter(o => o.id !== orderId);
                        const table = state.tables.find(t => t.id === order.tableId);
                        if (table) {
                            const hasPendingKots = state.kitchenOrders.some(ko => ko.tableId === table.id);
                            if (!hasPendingKots) {
                                table.status = 'billing';
                                playSound('billing-ready');
                            }
                        }
                        showToast(`${order.tableName}'s order has been served.`);
                        break;
                    case 'ready':
                        Swal.fire({
                            title: 'Is the order ready?',
                            text: `Confirm that all items for ${order.tableName} are prepared.`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: "Yes, it's ready!",
                            cancelButtonText: 'Not yet'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                order.status = 'ready';
                                playSound('order-ready');
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'info',
                                    title: `Order for ${order.tableName} is ready!`,
                                    html: 'Please pick it up from the kitchen.',
                                    showConfirmButton: false,
                                    timer: 5000,
                                    timerProgressBar: true
                                });
                                render();
                            }
                        });
                        return; // Prevent default render
                    case 'move-to-new':
                        order.status = 'new';
                        break;
                    case 'move-to-preparing':
                        order.status = 'preparing';
                        break;
                    default: // 'preparing'
                        order.status = action;
                        break;
                }
                render();
            });

            // Inventory: Restock
            $('body').on('click', '.restock-btn', function() {
                const itemId = $(this).data('item-id');
                const item = state.inventory.find(i => i.id === itemId);
                if (item) {
                    Swal.fire({
                        title: `Restock ${item.name}`,
                        input: 'number',
                        inputLabel: 'Quantity to add',
                        inputValue: 20,
                        showCancelButton: true,
                        inputValidator: (value) => {
                            if (!value || value <= 0) {
                                return 'Please enter a valid quantity!'
                            }
                        }
                    }).then(result => {
                        if (result.isConfirmed) {
                            item.stock += parseInt(result.value);
                            showToast(`${item.name} stock updated to ${item.stock}.`);
                            render();
                        }
                    });
                }
            });
            
            // Inventory: Open Add Item Modal
            $('body').on('click', '#add-inventory-item-btn', function() {
                $('#inventory-form')[0].reset();
                const categorySelect = $('#item-category');
                categorySelect.empty();
                Object.keys(state.menu).forEach(category => {
                    categorySelect.append(`<option value="${category}">${category}</option>`);
                });
                $('#inventoryModal').modal('show');
            });

            // Inventory: Handle form submission for new item
            $('#inventory-form').on('submit', function(e) {
                e.preventDefault();
                const newItemData = {
                    id: Date.now(),
                    name: $('#item-name').val(),
                    price: parseFloat($('#item-price').val()),
                    stock: parseInt($('#item-stock').val()),
                };
                const newItemInventory = {
                    ...newItemData,
                    supplier: $('#item-supplier').val() || 'Gourmet Foods Inc.',
                    lowStockThreshold: parseInt($('#item-low-stock').val())
                };

                const category = $('#item-category').val();

                if (state.menu[category]) {
                    state.menu[category].push(newItemData);
                    state.inventory.push(newItemInventory);
                    
                    $('#inventoryModal').modal('hide');
                    showToast('New item added successfully!');
                    render();
                } else {
                    showToast('Invalid category selected.', 'danger');
                }
            });

            // User Management: Add/Edit User
            $('body').on('click', '#add-user-btn', function() {
                $('#user-form')[0].reset();
                $('#user-id').val('');
                $('#userModalLabel').text('Add New User');
                $('#userModal').modal('show');
            });
            $('body').on('click', '.edit-user-btn', function() {
                const userId = $(this).data('user-id');
                const user = state.users[userId];
                if(user) {
                    $('#user-id').val(user.id);
                    $('#user-name').val(user.name);
                    $('#user-role').val(user.role);
                    $('#userModalLabel').text('Edit User');
                    $('#userModal').modal('show');
                }
            });
            $('#user-form').on('submit', function(e) {
                e.preventDefault();
                const userId = $('#user-id').val();
                const userName = $('#user-name').val();
                const userRole = $('#user-role').val();

                if (userId) { // Editing existing user
                    state.users[userId] = { ...state.users[userId], name: userName, role: userRole };
                    showToast('User updated successfully!');
                } else { // Adding new user
                    const newId = `user_${Date.now()}`;
                    state.users[newId] = { id: newId, name: userName, role: userRole };
                    showToast('User added successfully!');
                }
                $('#userModal').modal('hide');
                render();
            });
            // User Management: Remove User
            $('body').on('click', '.remove-user-btn', function() {
                const userId = $(this).data('user-id');
                const user = state.users[userId];
                Swal.fire({
                    title: 'Are you sure?',
                    text: `You are about to remove ${user.name}. This cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove them!',
                    cancelButtonText: 'No, keep them'
                }).then((result) => {
                    if (result.isConfirmed) {
                        delete state.users[userId];
                        Swal.fire('Removed!', `${user.name} has been removed.`, 'success');
                        render();
                    }
                });
            });

            // Table Management (Admin only)
            $('body').on('click', '#add-table-btn', function() {
                $('#table-form')[0].reset();
                $('#table-id').val('');
                $('#tableModalLabel').text('Add New Table');
                $('#table-status').prop('disabled', false);
                $('#tableModal').modal('show');
            });

            $('body').on('click', '.edit-table-btn', function() {
                const tableId = $(this).data('table-id');
                const table = state.tables.find(t => t.id === tableId);
                if (table) {
                    $('#table-id').val(table.id);
                    $('#table-name').val(table.name);
                    $('#table-status').val(table.status);
                    
                    // Prevent changing status if table is in use
                    if(table.status === 'occupied' || table.status === 'billing'){
                        $('#table-status').prop('disabled', true);
                    } else {
                        $('#table-status').prop('disabled', false);
                    }

                    $('#tableModalLabel').text(`Edit ${table.name}`);
                    $('#tableModal').modal('show');
                }
            });
            
             $('body').on('click', '.remove-table-btn', function() {
                const tableId = $(this).data('table-id');
                const table = state.tables.find(t => t.id === tableId);
                if (table) {
                    if(table.status !== 'available') {
                        Swal.fire('Cannot Remove', 'Only available tables can be removed.', 'error');
                        return;
                    }
                    Swal.fire({
                        title: 'Are you sure?',
                        text: `You are about to remove ${table.name}. This cannot be undone.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, remove it!',
                        cancelButtonText: 'No, keep it'
                    }).then((result) => {
                         if (result.isConfirmed) {
                            state.tables = state.tables.filter(t => t.id !== tableId);
                            Swal.fire('Removed!', `${table.name} has been removed.`, 'success');
                            render();
                        }
                    });
                }
            });

            $('#table-form').on('submit', function(e) {
                e.preventDefault();
                const tableId = parseInt($('#table-id').val());
                const tableName = $('#table-name').val();
                const tableStatus = $('#table-status').val();

                if (tableId) { // Editing
                    const table = state.tables.find(t => t.id === tableId);
                    if(table) {
                        table.name = tableName;
                        // Only change status if it's not locked
                        if(!$('#table-status').is(':disabled')){
                           table.status = tableStatus;
                        }
                    }
                    showToast('Table updated successfully!');
                } else { // Adding
                    const newId = state.tables.length > 0 ? Math.max(...state.tables.map(t => t.id)) + 1 : 1;
                    state.tables.push({
                        id: newId,
                        name: tableName,
                        status: tableStatus,
                        order: []
                    });
                     showToast('Table added successfully!');
                }
                $('#tableModal').modal('hide');
                render();
            });
            
            // Handle focus after modals close to prevent accessibility issues
            $('#orderModal, #billingModal').on('hidden.bs.modal', function () {
                if (document.activeElement) {
                    document.activeElement.blur();
                }
            });


            // --- INITIALIZATION ---
            initializeData();
            render();
        });
    </script>
</body>
</html>

